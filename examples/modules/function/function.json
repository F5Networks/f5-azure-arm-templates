{
	"$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
	"contentVersion": "9.0.0.0",
	"parameters": {
		"vmssId": {
			"defaultValue": "vmssId",
			"metadata": {
				"description": "Supply the fully-qualified resource ID of the VMSS to update."
			},
			"type": "string"
		},
		"bigIqAddress": {
			"defaultValue": "Default",
			"metadata": {
				"description": "The IP address (or hostname) for the BIG-IQ to be used when licensing the BIG-IP.  Note: The BIG-IP will make a REST call to the BIG-IQ (already existing) to let it know a BIG-IP needs to be licensed. It will then license the BIG-IP using the provided BIG-IQ credentials and license pool."
			},
			"type": "string"
		},
		"bigIqLicensePoolName": {
			"defaultValue": "Default",
			"metadata": {
				"description": "The BIG-IQ license pool to use during BIG-IP licensing via BIG-IQ."
			},
			"type": "string"
		},
		"bigIqPassword": {
			"defaultValue": "Default",
			"metadata": {
				"description": "The BIG-IQ password to use during BIG-IP licensing via BIG-IQ."
			},
			"type": "securestring"
		},
		"bigIqUsername": {
			"defaultValue": "azureuser",
			"metadata": {
				"description": "The BIG-IQ username to use during BIG-IP licensing via BIG-IQ."
			},
			"type": "string"
		},
		"bigIqTenant": {
			"defaultValue": "Default",
			"metadata": {
				"description": "The BIG-IQ tenant used during BIG-IP licensing via BIG-IQ."
			},
			"type": "string"
		},
		"bigIqUtilityKey": {
			"defaultValue": "Default",
			"metadata": {
				"description": "The BIG-IQ utility license key used during BIG-IP licensing via BIG-IQ."
			},
			"type": "string"
		},
		"bigIqUtilityOffer": {
			"defaultValue": "Default",
			"metadata": {
				"description": "The BIG-IQ utility offer ID used during BIG-IP licensing via BIG-IQ."
			},
			"type": "string"
		},
		"functionAppName": {
			"defaultValue": "functionApp",
			"metadata": {
				"description": "Supply a name for the function app."
			},
			"type": "string"
		},
		"functionAppSku": {
			"defaultValue": {
				"Tier": "ElasticPremium",
				"Name": "EP1"
			},
			"metadata": {
				"description": "Enter json configuration to configure the Azure server farm plan premium or appservice sku. See https://docs.microsoft.com/en-us/azure/templates/microsoft.web/2018-02-01/serverfarms for supported values."
			},
			"type": "object"
		},
		"functionAppVnetId": {
			"defaultValue": "Default",
			"metadata": {
				"description": "The fully qualified resource ID of virtual network where BIG-IQ is deployed."
			},
			"type": "string"
		},
		"tagValues": {
			"defaultValue": {
				"application": "APP",
				"cost": "COST",
				"environment": "ENV",
				"group": "GROUP",
				"owner": "OWNER"
			},
			"metadata": {
				"description": "Default key/value resource tags will be added to the resources in this deployment, if you would like the values to be unique adjust them as needed for each key."
			},
			"type": "object"
		}
	},
	"variables": {
		"appInightsApiVersion": "2018-05-01-preview",
		"applicationInsightsName": "[variables('functionAppName')]",
		"authApiVersion": "2018-07-01",
		"functionAppApiVersion": "2018-11-01",
		"functionAppName": "[concat(parameters('functionAppName'), '-function')]",
		"functionAppVnetName": "[last(split(parameters('functionAppVnetId'),'/'))]",
		"functionStorageAccountId": "[concat(resourceGroup().id,'/providers/','Microsoft.Storage/storageAccounts/', variables('functionStorageAccountName'))]",
		"functionStorageAccountName": "[concat(uniquestring(resourceGroup().id), 'azfunctions')]",
		"functionWorkerRuntime": "python",
		"hostingPlanName": "[concat(parameters('functionAppName'), '-plan')]",
		"identityApiVersion": "2018-11-30",
		"identityName": "[concat(parameters('functionAppName'), '-identity')]",
		"keyVaultApiVersion": "2018-02-14",
		"keyVaultName": "[concat(parameters('functionAppName'), 'fv')]",
		"location": "[resourceGroup().location]",
		"vmssName": "[last(split(parameters('vmssId'),'/'))]",
		"resourceGroupName": "[split(parameters('vmssId'),'/')[4]]",
		"secretName": "[concat(parameters('functionAppName'), 'bigiq')]",
		"serverFarmApiVersion": "2018-02-01",
		"storageApiVersion": "2017-10-01",
		"subscriptionID": "[subscription().subscriptionId]"			
	},
	"resources": [
		{
			"apiVersion": "[variables('storageApiVersion')]",
			"kind": "Storage",
			"location": "[variables('location')]",
			"name": "[variables('functionStorageAccountName')]",
			"sku": {
				"name": "Standard_LRS"
			},
			"type": "Microsoft.Storage/storageAccounts"
		},
		{
			"apiVersion": "2018-02-01",
			"kind": "linux",
			"location": "[variables('location')]",
			"name": "[variables('hostingPlanName')]",
			"properties": {
				"reserved": true
			},
			"sku": "[parameters('functionAppSku')]",
			"type": "Microsoft.Web/serverfarms"
		},
		{
			"apiVersion": "[variables('functionAppApiVersion')]",
			"dependsOn": [
				"[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]"
			],
			"identity": {
				"type": "SystemAssigned"
			},
			"kind": "functionapp",
			"location": "[variables('location')]",
			"name": "[variables('functionAppName')]",
			"properties": {
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
				"siteConfig": {
					"appSettings": [
						{
							"name": "FUNCTIONS_EXTENSION_VERSION",
							"value": "~3"
						}
					],
					"linuxFxVersion": "PYTHON|3.7"
				}
			},
			"resources": [
				{
					"apiVersion": "[variables('functionAppApiVersion')]",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('functionAppName'))]",
						"[resourceId('Microsoft.KeyVault/vaults/', variables('keyVaultName'))]",
						"[resourceId('Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), variables('secretName'))]",
						"[resourceId('Microsoft.Storage/storageAccounts', variables('functionStorageAccountName'))]",
						"[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
					],
					"name": "appsettings",
					"properties": {
						"APPINSIGHTS_INSTRUMENTATIONKEY": "[reference(resourceId('Microsoft.Insights/components/', variables('applicationInsightsName')), '2015-05-01').InstrumentationKey]",
						"AZURE_RESOURCE_GROUP": "[variables('resourceGroupName')]",
						"AZURE_VMSS_NAME": "[variables('vmssName')]",
						"AzureWebJobsStorage": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('functionStorageAccountName'), ';AccountKey=', listKeys(variables('functionStorageAccountId'),'2015-05-01-preview').key1)]",
						"BIGIQ_ADDRESS": "[parameters('bigIqAddress')]",
						"BIGIQ_LICENSE_POOL": "[if(equals(parameters('bigIqLicensePoolName'), 'Default'), json('null'), parameters('bigIqLicensePoolName'))]",
						"BIGIQ_PASSWORD": "[concat('@Microsoft.KeyVault(SecretUri=https://', variables('keyVaultName'), '.vault.azure.net/secrets/', variables('secretName'), '/)')]",
						"BIGIQ_USERNAME": "[parameters('bigIqUsername')]",
						"BIGIQ_UTILITY_KEY": "[if(equals(parameters('bigIqUtilityKey'), 'Default'), json('null'), parameters('bigIqUtilityKey'))]",
						"BIGIQ_UTILITY_OFFER": "[if(equals(parameters('bigIqUtilityOffer'), 'Default'), json('null'), parameters('bigIqUtilityOffer'))]",
						"F5_DISABLE_SSL_WARNINGS": false,
						"TENANT": "[if(empty(parameters('bigIqTenant')), variables('vmssName'), parameters('bigIqTenant'))]",
						"FUNCTIONS_EXTENSION_VERSION": "~3",
						"FUNCTIONS_WORKER_RUNTIME": "[variables('functionWorkerRuntime')]",
						"WEBSITE_ENABLE_SYNC_UPDATE_SITE": true,
						"WEBSITE_NODE_DEFAULT_VERSION": "~12",
						"WEBSITE_RUN_FROM_PACKAGE": "https://cdn.f5.com/product/cloudsolutions/f5-cloud-functions/azure/TimerTriggerRevoke/v1.0.0/timer_trigger_revoke.zip"
					},
					"type": "config"
				},
				{
					"apiVersion": "[variables('functionAppApiVersion')]",
					"condition": "[not(equals(parameters('functionAppVnetId'), 'Default'))]",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
					],
					"location": "[variables('location')]",
					"name": "[variables('functionAppVnetName')]",
					"properties": {
						"vnetResourceId": "[parameters('functionAppVnetId')]"
					},
					"type": "virtualNetworkConnections"
				}
			],
			"type": "Microsoft.Web/sites"
		},
		{
			"apiVersion": "[variables('authApiVersion')]",
			"dependsOn": [
				"[resourceId('Microsoft.Web/sites', variables('functionAppName'))]",
				"[resourceId('Microsoft.Web/sites/config', variables('functionAppName'), 'appsettings')]",
				"[resourceId('Microsoft.Web/sites/virtualNetworkConnections', variables('functionAppName'), variables('functionAppVnetName'))]"
			],
			"name": "[guid(concat(parameters('functionAppName'), '-role'))]",
			"properties": {
				"principalId": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2018-11-01', 'Full').identity.principalId]",
				"roleDefinitionId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
				"scope": "[resourceGroup().id]"
			},
			"type": "Microsoft.Authorization/roleAssignments"
		},
		{
			"apiVersion": "[variables('keyVaultApiVersion')]",
			"dependsOn": [
				"[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
			],
			"location": "[variables('location')]",
			"name": "[variables('keyVaultName')]",
			"properties": {
				"accessPolicies": [
					{
						"objectId": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2018-11-01', 'Full').identity.principalId]",
						"permissions": {
							"secrets": [
								"get"
							]
						},
						"tenantId": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2018-11-01', 'Full').identity.tenantId]"
					}
				],
				"networkAcls": {
					"bypass": "AzureServices",
					"defaultAction": "Allow"
				},
				"sku": {
					"family": "A",
					"name": "standard"
				},
				"tenantId": "[subscription().tenantId]"
			},
			"resources": [
				{
					"apiVersion": "[variables('keyVaultApiVersion')]",
					"dependsOn": [
						"[resourceId('Microsoft.KeyVault/vaults/', variables('keyVaultName'))]",
						"[resourceId('Microsoft.Storage/storageAccounts', variables('functionStorageAccountName'))]"
					],
					"name": "[variables('secretName')]",
					"properties": {
						"value": "[parameters('bigIqPassword')]"
					},
					"type": "secrets"
				}
			],
			"type": "Microsoft.KeyVault/vaults"
		},
		{
			"apiVersion": "[variables('appInightsApiVersion')]",
			"location": "[variables('location')]",
			"name": "[variables('applicationInsightsName')]",
			"properties": {
				"ApplicationId": "[variables('applicationInsightsName')]",
				"Request_Source": "IbizaWebAppExtensionCreate"
			},
			"tags": {
				"[concat('hidden-link:', resourceGroup().id, '/providers/Microsoft.Web/sites/', variables('applicationInsightsName'))]": "Resource"
			},
			"type": "Microsoft.Insights/components"
		}
	],
	"outputs": {
		"storageAccountId": {
			"type": "string",
			"value": "[resourceId('Microsoft.Storage/storageAccounts', variables('functionStorageAccountName'))]"
		},
		"hostingPlanId": {
			"type": "string",
			"value": "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]"
		},
		"functionAppId": {
			"type": "string",
			"value": "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
		},
		"keyVaultId": {
			"type": "string",
			"value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
		},
		"applicationInsightsId": {
			"type": "string",
			"value": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
		},
        "roleAssignmentId": {
			"type": "string",
            "value": "[concat('/subscriptions/',subscription().subscriptionId, '/resourcegroups/',  resourceGroup().name, '/providers/Microsoft.Authorization/roleAssignments/', guid(concat(parameters('functionAppName'), '-role')))]"
		}
	}
}