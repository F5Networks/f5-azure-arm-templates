{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json", 
    "contentVersion": "1.0.0.0", 
    "parameters": {
        "adminUsername": {
            "defaultValue": "azureuser", 
            "type": "string", 
            "metadata": {
                "description": "User name for the Virtual Machine."
            }
        }, 
        "adminPassword": {
            "type": "securestring", 
            "metadata": {
                "description": "Password to login to the Virtual Machine."
            }
        }, 
        "dnsLabel": {
            "defaultValue": "REQUIRED", 
            "type": "string", 
            "metadata": {
                "description": "Unique DNS Name for the Public IP used to access the Virtual Machine."
            }
        }, 
        "instanceName": {
            "defaultValue": "f5vm01", 
            "type": "string", 
            "metadata": {
                "description": "Name of the VM"
            }
        }, 
        "instanceType": {
            "defaultValue": "Standard_D2_v2", 
            "metadata": {
                "description": "Size of the VM"
            }, 
            "type": "string", 
            "allowedValues": [
                "Standard_A4", 
                "Standard_A9", 
                "Standard_A11", 
                "Standard_D2", 
                "Standard_D3", 
                "Standard_D4", 
                "Standard_D12", 
                "Standard_D13", 
                "Standard_D14", 
                "Standard_D2_v2", 
                "Standard_D3_v2", 
                "Standard_D4_v2", 
                "Standard_D5_v2", 
                "Standard_D12_v2", 
                "Standard_D13_v2", 
                "Standard_D14_v2", 
                "Standard_D15_v2"
            ]
        }, 
        "imageName": {
            "defaultValue": "Good", 
            "metadata": {
                "description": "F5 SKU(IMAGE) to Deploy"
            }, 
            "type": "string", 
            "allowedValues": [
                "Good", 
                "Better", 
                "Best"
            ]
        }, 
        "licenseKey1": {
            "defaultValue": "REQUIRED", 
            "type": "string", 
            "metadata": {
                "description": "The license token for the F5 BIG-IP(BYOL)"
            }
        }, 
        "restrictedSrcAddress": {
            "defaultValue": "*", 
            "type": "string", 
            "metadata": {
                "description": "Restricts management access to a specific network or address. Enter a IP address or address range in CIDR notation, or asterisk for all sources."
            }
        }, 
        "tagValues": {
            "defaultValue": {
                "environment": "ENV", 
                "application": "APP", 
                "cost": "COST", 
                "group": "GROUP", 
                "owner": "OWNER"
            }, 
            "type": "object"
        }
    }, 
    "variables": {
        "apiVersion": "2015-06-15", 
        "location": "[resourceGroup().location]", 
        "singleQuote": "'", 
        "f5CloudLibsTag": "v2.0.0", 
        "expectedHash": "8bb8ca730dce21dff6ec129a84bdb1689d703dc2b0227adcbd16757d5eeddd767fbe7d8d54cc147521ff2232bd42eebe78259069594d159eceb86a88ea137b73", 
        "verifyHash": "[concat(variables('singleQuote'), 'cli script /Common/verifyHash {\nproc script::run {} {\n        if {[catch {\n            set file_path [lindex $tmsh::argv 1]\n            set expected_hash ', variables('expectedHash'), '\n            set computed_hash [lindex [exec /usr/bin/openssl dgst -r -sha512 $file_path] 0]\n            if { $expected_hash eq $computed_hash } {\n                exit 0\n            }\n            tmsh::log err {Hash does not match}\n            exit 1\n        }]} {\n            tmsh::log err {Unexpected error in verifyHash}\n            exit 1\n        }\n    }\n    script-signature fc3P5jEvm5pd4qgKzkpOFr9bNGzZFjo9pK0diwqe/LgXwpLlNbpuqoFG6kMSRnzlpL54nrnVKREf6EsBwFoz6WbfDMD3QYZ4k3zkY7aiLzOdOcJh2wECZM5z1Yve/9Vjhmpp4zXo4varPVUkHBYzzr8FPQiR6E7Nv5xOJM2ocUv7E6/2nRfJs42J70bWmGL2ZEmk0xd6gt4tRdksU3LOXhsipuEZbPxJGOPMUZL7o5xNqzU3PvnqZrLFk37bOYMTrZxte51jP/gr3+TIsWNfQEX47nxUcSGN2HYY2Fu+aHDZtdnkYgn5WogQdUAjVVBXYlB38JpX1PFHt1AMrtSIFg==\n}', variables('singleQuote'))]", 
        "installCloudLibs": "[concat(variables('singleQuote'), '#!/bin/bash\necho about to execute\nchecks=0\nwhile [ $checks -lt 120 ]; do echo checking mcpd\n/usr/bin/tmsh -a show sys mcp-state field-fmt | grep -q running\nif [ $? == 0 ]; then\necho mcpd ready\nbreak\nfi\necho mcpd not ready yet\nlet checks=checks+1\nsleep 1\ndone\necho loading verifyHash script\n/usr/bin/tmsh load sys config merge file /config/verifyHash\nif [ $? != 0 ]; then\necho cannot validate signature of /config/verifyHash\nexit\nfi\necho loaded verifyHash\necho verifying f5-cloud-libs.targ.gz\n/usr/bin/tmsh run cli script verifyHash /config/cloud/f5-cloud-libs.tar.gz\nif [ $? != 0 ]; then\necho f5-cloud-libs.tar.gz is not valid\nexit\nfi\necho verified f5-cloud-libs.tar.gz\necho expanding f5-cloud-libs.tar.gz\ntar xvfz /config/cloud/f5-cloud-libs.tar.gz -C /config/cloud\ntouch /config/cloud/cloudLibsReady', variables('singleQuote'))]", 
        "storageAccountName": "[concat(uniquestring(resourceGroup().id), 'sa1nic')]", 
        "storageAccountType": "Standard_LRS", 
        "imageNameToLower": "[toLower(parameters('imageName'))]", 
        "skuToUse": "[concat('f5-bigip-virtual-edition-', variables('imageNameToLower'),'-byol')]", 
        "availabilitySetName": "[concat(parameters('instanceName'), '-availset')]", 
        "nic1Name": "[concat(parameters('instanceName'), '-mgmt1')]", 
        "defaultGw": "10.0.1.1", 
        "vnetName": "[concat(parameters('instanceName'), '-vnet')]", 
        "vnetId": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]", 
        "addressPrefix": "10.0.0.0/16", 
        "subnet1Name": "MGMT_Frontend", 
        "subnet1Id": "[concat(variables('vnetId'), '/subnets/', variables('subnet1Name'))]", 
        "subnet1Prefix": "10.0.1.0/24", 
        "subnet1PrivateAddress": "10.0.1.4", 
        "publicIPAddressName": "[concat(parameters('dnsLabel'), '-pip')]", 
        "publicIPAddressType": "Static", 
        "publicIPAddressId": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressName'))]", 
        "nsgID": "[resourceId('Microsoft.Network/networkSecurityGroups/',concat(parameters('dnsLabel'),'-nsg'))]", 
        "subnet2Name": "Web", 
        "subnet2Id": "[concat(variables('vnetId'), '/subnets/', variables('subnet2Name'))]", 
        "subnet2Prefix": "10.0.2.0/24", 
        "subnet2PrivateAddress": "10.0.2.4", 
        "nic2Name": "[concat(parameters('instanceName'), '-nic2')]"
    }, 
    "resources": [
        {
            "name": "[variables('publicIPAddressName')]", 
            "tags": {
                "displayName": "PublicIPAddress", 
                "environment": "[parameters('tagValues').environment]", 
                "application": "[parameters('tagValues').application]", 
                "costCenter": "[parameters('tagValues').cost]", 
                "owner": "[parameters('tagValues').owner]", 
                "group": "[parameters('tagValues').group]"
            }, 
            "apiVersion": "[variables('apiVersion')]", 
            "location": "[resourceGroup().location]", 
            "type": "Microsoft.Network/publicIPAddresses", 
            "properties": {
                "publicIPAllocationMethod": "[variables('publicIPAddressType')]", 
                "dnsSettings": {
                    "domainNameLabel": "[parameters('dnsLabel')]"
                }, 
                "idleTimeoutInMinutes": 30
            }
        }, 
        {
            "name": "[variables('vnetName')]", 
            "tags": {
                "displayName": "NetworkInterface", 
                "environment": "[parameters('tagValues').environment]", 
                "application": "[parameters('tagValues').application]", 
                "costCenter": "[parameters('tagValues').cost]", 
                "owner": "[parameters('tagValues').owner]", 
                "group": "[parameters('tagValues').group]"
            }, 
            "apiVersion": "[variables('apiVersion')]", 
            "location": "[resourceGroup().location]", 
            "type": "Microsoft.Network/virtualNetworks", 
            "properties": {
                "subnets": [
                    {
                        "name": "[variables('subnet1Name')]", 
                        "properties": {
                            "addressPrefix": "[variables('subnet1Prefix')]"
                        }
                    }, 
                    {
                        "name": "[variables('subnet2Name')]", 
                        "properties": {
                            "addressPrefix": "[variables('subnet2Prefix')]"
                        }
                    }
                ], 
                "addressSpace": {
                    "addressPrefixes": [
                        "[variables('addressPrefix')]"
                    ]
                }
            }
        }, 
        {
            "name": "[variables('nic1Name')]", 
            "tags": {
                "displayName": "PublicIPAddress", 
                "environment": "[parameters('tagValues').environment]", 
                "application": "[parameters('tagValues').application]", 
                "costCenter": "[parameters('tagValues').cost]", 
                "owner": "[parameters('tagValues').owner]", 
                "group": "[parameters('tagValues').group]"
            }, 
            "apiVersion": "[variables('apiVersion')]", 
            "location": "[resourceGroup().location]", 
            "dependsOn": [
                "[variables('vnetId')]", 
                "[variables('publicIPAddressId')]", 
                "[concat('Microsoft.Network/networkSecurityGroups/', parameters('dnsLabel'),'-nsg')]"
            ], 
            "type": "Microsoft.Network/networkInterfaces", 
            "properties": {
                "networkSecurityGroup": {
                    "id": "[variables('nsgID')]"
                }, 
                "ipConfigurations": [
                    {
                        "name": "[concat(parameters('instanceName'), '-ipconfig1')]", 
                        "properties": {
                            "subnet": {
                                "id": "[variables('subnet1Id')]"
                            }, 
                            "privateIPAllocationMethod": "Static", 
                            "privateIPAddress": "[variables('subnet1PrivateAddress')]", 
                            "PublicIpAddress": {
                                "Id": "[variables('publicIPAddressId')]"
                            }
                        }
                    }
                ]
            }
        }, 
        {
            "name": "[variables('nic2Name')]", 
            "tags": {
                "displayName": "NetworkInterface", 
                "environment": "[parameters('tagValues').environment]", 
                "application": "[parameters('tagValues').application]", 
                "costCenter": "[parameters('tagValues').cost]", 
                "owner": "[parameters('tagValues').owner]", 
                "group": "[parameters('tagValues').group]"
            }, 
            "apiVersion": "[variables('apiVersion')]", 
            "location": "[resourceGroup().location]", 
            "dependsOn": [
                "[variables('vnetId')]"
            ], 
            "type": "Microsoft.Network/networkInterfaces", 
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "[concat(parameters('instanceName'), '-ipconfig2')]", 
                        "properties": {
                            "subnet": {
                                "id": "[variables('subnet2Id')]"
                            }, 
                            "privateIPAllocationMethod": "Static", 
                            "privateIPAddress": "[variables('subnet2PrivateAddress')]"
                        }
                    }
                ]
            }
        }, 
        {
            "name": "[concat(parameters('dnsLabel'), '-nsg')]", 
            "tags": {
                "displayName": "NetworkSecurityGroup", 
                "environment": "[parameters('tagValues').environment]", 
                "application": "[parameters('tagValues').application]", 
                "costCenter": "[parameters('tagValues').cost]", 
                "owner": "[parameters('tagValues').owner]", 
                "group": "[parameters('tagValues').group]"
            }, 
            "apiVersion": "[variables('apiVersion')]", 
            "location": "[variables('location')]", 
            "type": "Microsoft.Network/networkSecurityGroups", 
            "properties": {
                "securityRules": [
                    {
                        "name": "mgmt_allow_443", 
                        "properties": {
                            "priority": 101, 
                            "access": "Allow", 
                            "direction": "Inbound", 
                            "destinationPortRange": "443", 
                            "description": "", 
                            "protocol": "TCP", 
                            "destinationAddressPrefix": "*", 
                            "sourcePortRange": "*", 
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddress')]"
                        }
                    }, 
                    {
                        "name": "ssh_allow_22", 
                        "properties": {
                            "priority": 102, 
                            "access": "Allow", 
                            "direction": "Inbound", 
                            "destinationPortRange": "22", 
                            "description": "", 
                            "protocol": "TCP", 
                            "destinationAddressPrefix": "*", 
                            "sourcePortRange": "*", 
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddress')]"
                        }
                    }
                ]
            }
        }, 
        {
            "tags": {
                "displayName": "AvailabilitySet", 
                "environment": "[parameters('tagValues').environment]", 
                "application": "[parameters('tagValues').application]", 
                "costCenter": "[parameters('tagValues').cost]", 
                "owner": "[parameters('tagValues').owner]", 
                "group": "[parameters('tagValues').group]"
            }, 
            "type": "Microsoft.Compute/availabilitySets", 
            "location": "[resourceGroup().location]", 
            "apiVersion": "[variables('apiVersion')]", 
            "name": "[variables('availabilitySetName')]"
        }, 
        {
            "name": "[variables('storageAccountName')]", 
            "tags": {
                "displayName": "StorageAccount", 
                "environment": "[parameters('tagValues').environment]", 
                "application": "[parameters('tagValues').application]", 
                "costCenter": "[parameters('tagValues').cost]", 
                "owner": "[parameters('tagValues').owner]", 
                "group": "[parameters('tagValues').group]"
            }, 
            "apiVersion": "[variables('apiVersion')]", 
            "location": "[resourceGroup().location]", 
            "type": "Microsoft.Storage/storageAccounts", 
            "properties": {
                "accountType": "[variables('storageAccountType')]"
            }
        }, 
        {
            "location": "[resourceGroup().location]", 
            "dependsOn": [
                "[concat('Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]", 
                "[concat('Microsoft.Compute/availabilitySets/', variables('availabilitySetName'))]", 
                "[concat('Microsoft.Network/networkInterfaces/', variables('nic1Name'))]"
            ], 
            "plan": {
                "publisher": "f5-networks", 
                "product": "f5-big-ip", 
                "name": "[variables('skuToUse')]"
            }, 
            "tags": {
                "displayName": "VirtualMachine", 
                "environment": "[parameters('tagValues').environment]", 
                "application": "[parameters('tagValues').application]", 
                "costCenter": "[parameters('tagValues').cost]", 
                "owner": "[parameters('tagValues').owner]", 
                "group": "[parameters('tagValues').group]"
            }, 
            "type": "Microsoft.Compute/virtualMachines", 
            "properties": {
                "osProfile": {
                    "adminUsername": "[parameters('adminUsername')]", 
                    "computerName": "[parameters('instanceName')]", 
                    "adminPassword": "[parameters('adminPassword')]"
                }, 
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nic1Name'))]", 
                            "properties": {
                                "primary": true
                            }
                        }, 
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nic2Name'))]", 
                            "properties": {
                                "primary": false
                            }
                        }
                    ]
                }, 
                "storageProfile": {
                    "imageReference": {
                        "sku": "[variables('skuToUse')]", 
                        "publisher": "f5-networks", 
                        "version": "latest", 
                        "offer": "f5-big-ip"
                    }, 
                    "osDisk": {
                        "caching": "ReadWrite", 
                        "vhd": {
                            "uri": "[concat('http://',variables('storageAccountName'), '.blob.core.windows.net/vhds/', parameters('instanceName'), '.vhd')]"
                        }, 
                        "createOption": "FromImage", 
                        "name": "osdisk"
                    }
                }, 
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "storageUri": "[concat('http://',variables('storageAccountName'),'.blob.core.windows.net')]", 
                        "enabled": true
                    }
                }, 
                "hardwareProfile": {
                    "vmSize": "[parameters('instanceType')]"
                }, 
                "availabilitySet": {
                    "id": "[resourceId('Microsoft.Compute/availabilitySets',variables('availabilitySetName'))]"
                }
            }, 
            "apiVersion": "[variables('apiVersion')]", 
            "name": "[parameters('instanceName')]"
        }, 
        {
            "name": "[concat(parameters('instanceName'),'/start')]", 
            "apiVersion": "2016-03-30", 
            "location": "[variables('location')]", 
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', parameters('instanceName'))]"
            ], 
            "type": "Microsoft.Compute/virtualMachines/extensions", 
            "properties": {
                "protectedSettings": {
                    "commandToExecute": "[concat('mkdir /config/cloud && cp f5-cloud-libs.tar.gz* /config/cloud; /usr/bin/install -b -m 755 /dev/null /config/verifyHash; /usr/bin/install -b -m 755 /dev/null /config/installCloudLibs.sh; /usr/bin/install -b -m 400 /dev/null /config/cloud/passwd; IFS=', variables('singleQuote'), '%', variables('singleQuote'), '; echo -e ', variables('verifyHash'), ' >> /config/verifyHash; echo -e ', variables('installCloudLibs'), ' >> /config/installCloudLibs.sh; echo -e ', parameters('adminPassword'), ' >> /config/cloud/passwd; unset IFS; bash /config/installCloudLibs.sh; /usr/bin/f5-rest-node /config/cloud/f5-cloud-libs/scripts/onboard.js --output /var/log/onboard.log --log-level debug --host ', variables('subnet1PrivateAddress'), ' -u admin --password-url file:///config/cloud/passwd --hostname ', concat(parameters('instanceName'), '.', resourceGroup().location, '.cloudapp.azure.com'), ' --license ', parameters('licenseKey1'), ' --ntp pool.ntp.org --db tmm.maxremoteloglength:2048 --module ltm:nominal --module afm:none; f5-rest-node /config/cloud/f5-cloud-libs/scripts/network.js --output /var/log/network.log --host ', variables('subnet1PrivateAddress'), ' -u admin -p ', parameters('adminPassword'), ' --multi-nic --default-gw ', variables('defaultGw'), ' --vlan vlan_mgmt,1.0 --vlan vlan_1,1.1 --self-ip self_mgmt,', variables('subnet1PrivateAddress'), ',vlan_mgmt --self-ip self_1,', variables('subnet2PrivateAddress'), ',vlan_1 --log-level debug --background --force-reboot; rm -f /config/cloud/passwd')]"
                }, 
                "publisher": "Microsoft.Azure.Extensions", 
                "typeHandlerVersion": "2.0", 
                "type": "CustomScript", 
                "settings": {
                    "fileUris": [
                        "[concat('https://raw.githubusercontent.com/F5Networks/f5-cloud-libs/', variables('f5CloudLibsTag'), '/dist/f5-cloud-libs.tar.gz')]"
                    ]
                }
            }
        }
    ], 
    "outputs": {
        "MGMT-URL": {
            "type": "string", 
            "value": "[concat('https://', parameters('dnsLabel'), '.', resourceGroup().location, '.cloudapp.azure.com')]"
        }
    }
}