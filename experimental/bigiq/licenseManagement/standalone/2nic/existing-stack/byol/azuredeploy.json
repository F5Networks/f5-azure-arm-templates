{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "5.3.0.0",
    "parameters": {
        "adminUsername": {
            "defaultValue": "azureuser",
            "metadata": {
                "description": "User name for the Virtual Machine."
            },
            "type": "string"
        },
        "authenticationType": {
            "allowedValues": [
                "password",
                "sshPublicKey"
            ],
            "defaultValue": "password",
            "metadata": {
                "description": "Type of authentication to use on the Virtual Machine, password based authentication or key based authentication."
            },
            "type": "string"
        },
        "adminPasswordOrKey": {
            "metadata": {
                "description": "Password or SSH public key to login to the Virtual Machine. Note: There are a number of special characters that you should avoid using for F5 product user accounts.  See [K2873](https://support.f5.com/csp/article/K2873) for details. Note: If using key-based authentication, this should be the public key as a string, typically starting with **---- BEGIN SSH2 PUBLIC KEY ----** and ending with **---- END SSH2 PUBLIC KEY ----**."
            },
            "type": "securestring"
        },
        "dnsLabel": {
            "defaultValue": "",
            "metadata": {
                "description": "Unique DNS Name for the Public IP address used to access the Virtual Machine."
            },
            "type": "string"
        },
        "instanceName": {
            "defaultValue": "f5vm01",
            "metadata": {
                "description": "Name of the Virtual Machine."
            },
            "type": "string"
        },
        "instanceType": {
            "allowedValues": [
                "Standard_D4s_v3",
                "Standard_D2s_v3",
                "Standard_D8s_v3"
            ],
            "defaultValue": "Standard_DS2_v2",
            "metadata": {
                "description": "Instance size of the Virtual Machine."
            },
            "type": "string"
        },
        "bigIqVersion": {
            "allowedValues": [
                "6.0.100813"
            ],
            "defaultValue": "6.0.100813",
            "metadata": {
                "description": "F5 BIG-IQ version you want to use."
            },
            "type": "string"
        },
        "bigIqLicenseKey1": {
            "defaultValue": "",
            "metadata": {
                "description": "F5 BYOL BIG-IQ License Manager registration key."
            },
            "maxLength": 255,
            "minLength": 1,
            "type": "string"
        },
        "licensePoolKeys": {
            "defaultValue": "Do_Not_Create",
            "metadata": {
                "description": "Enter a pool name and registration key using the format of name:key. Leave Do_Not_Create if you do not want to create a licensing pool on BIG-IQ at this time."
            },
            "maxLength": 255,
            "minLength": 1,
            "type": "string"
        },
        "regPoolKeys": {
            "defaultValue": "Do_Not_Create",
            "metadata": {
                "description": "Enter a pool name and a list of individual BIG-IP registration keys in the format of name:key,key,key. Leave Do_Not_Create if you do not want to create a reg key pool on BIG-IQ at this time."
            },
            "maxLength": 255,
            "minLength": 1,
            "type": "string"
        },
        "numberOfInternalIps": {
            "allowedValues": [
                0,
                1
            ],
            "defaultValue": 1,
            "metadata": {
                "description": "The number of public/private IP addresses you want to deploy for the application traffic (internal) NIC on the BIG-IQ VE to be used for virtual servers."
            },
            "type": "int"
        },
        "vnetName": {
            "metadata": {
                "description": "The name of the existing virtual network to which you want to connect the BIG-IQ VEs."
            },
            "type": "string"
        },
        "vnetResourceGroupName": {
            "metadata": {
                "description": "The name of the resource group that contains the Virtual Network where the BIG-IQ VE will be placed."
            },
            "type": "string"
        },
        "mgmtSubnetName": {
            "metadata": {
                "description": "Name of the existing mgmt subnet - with external access to the Internet. **Important**: The subnet you provide for the mgmt NIC **must** be unique."
            },
            "type": "string"
        },
        "mgmtIpAddress": {
            "metadata": {
                "description": "MGMT subnet IP Address to use for the BIG-IQ management IP address."
            },
            "type": "string"
        },
        "internalSubnetName": {
            "metadata": {
                "description": "Name of the existing internal subnet. **Important**: The subnet you provide for the internal NIC **must** be unique."
            },
            "type": "string"
        },
        "internalIpAddressRangeStart": {
            "metadata": {
                "description": "The static private IP address want to assign to the first internal Azure public IP (for self IP). An additional private IP address will be assigned for each public IP address you specified in **numberOfInternalIps**.  For example, entering 10.100.1.50 here and choosing 2 in numberOfInternalIps would result in 10.100.1.50 (self IP), 10.100.1.51 and 10.100.1.52 being configured as static private IP addresses for internal virtual servers."
            },
            "type": "string"
        },
        "avSetChoice": {
            "defaultValue": "CREATE_NEW",
            "metadata": {
                "description": "If you want the VM placed in a new Azure Availability Set, leave the default value of **CREATE_NEW**, otherwise specify the name of the existing Availability Set you want to use. Note: If you are using an existing AV Set, this deployment must be in the same Azure Resource Group as the AV Set."
            },
            "type": "string"
        },
        "ntpServer": {
            "defaultValue": "0.pool.ntp.org",
            "metadata": {
                "description": "Leave the default NTP server the BIG-IQ uses, or replace the default NTP server with the one you want to use."
            },
            "type": "string"
        },
        "timeZone": {
            "defaultValue": "UTC",
            "metadata": {
                "description": "If you would like to change the time zone the BIG-IQ uses, enter the time zone you want to use. This is based on the tz database found in /usr/share/zoneinfo (see the full list [here](https://github.com/F5Networks/f5-azure-arm-templates/blob/master/azure-timezone-list.md)). Example values: UTC, US/Pacific, US/Eastern, Europe/London or Asia/Singapore."
            },
            "type": "string"
        },
        "customImage": {
            "defaultValue": "OPTIONAL",
            "metadata": {
                "description": "If you would like to deploy using a local BIG-IQ image, provide either the full URL to the VHD in Azure storage **or** the full resource ID to an existing Microsoft.Compute image resource.  **Note**: Unless specifically required, leave the default of **OPTIONAL**."
            },
            "type": "string"
        },
        "restrictedSrcAddress": {
            "defaultValue": "*",
            "metadata": {
                "description": "Source Address(es) for Management Access. The IP address range used to SSH and access management GUI on the BIG-IQ."
            },
            "type": "string"
        },
        "restrictedSrcAddressApp": {
            "defaultValue": "*",
            "metadata": {
                "description": "Source Address(es) for internal Management Access. The IP address range that can be used to access BIG-IQ on the specified internal network via port 443."
            },
            "type": "string"
        },
        "tagValues": {
            "defaultValue": {
                "application": "APP",
                "cost": "COST",
                "environment": "ENV",
                "group": "GROUP",
                "owner": "OWNER"
            },
            "metadata": {
                "description": "Default key/value resource tags will be added to the resources in this deployment, if you would like the values to be unique adjust them as needed for each key."
            },
            "type": "object"
        },
        "allowUsageAnalytics": {
            "allowedValues": [
                "Yes",
                "No"
            ],
            "defaultValue": "Yes",
            "metadata": {
                "description": "This deployment can send anonymous statistics to F5 to help us determine how to improve our solutions. If you select **No** statistics are not sent."
            },
            "type": "string"
        }
    },
    "variables": {
        "computeApiVersion": "2017-12-01",
        "networkApiVersion": "2017-11-01",
        "storageApiVersion": "2017-10-01",
        "location": "[resourceGroup().location]",
        "adminPasswordOrKey": "[replace(parameters('adminPasswordOrKey'),'\\n', '\n')]",
        "linuxConfiguration": {
            "disablePasswordAuthentication": true,
            "ssh": {
                "publicKeys": [
                    {
                        "keyData": "[variables('adminPasswordOrKey')]",
                        "path": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]"
                    }
                ]
            }
        },
        "subscriptionID": "[subscription().subscriptionId]",
        "resourceGroupName": "[resourceGroup().name]",
        "singleQuote": "'",
        "f5CloudLibsTag": "v4.4.0",
        "f5CloudLibsAzureTag": "v2.4.0",
        "dnsLabel": "[toLower(parameters('dnsLabel'))]",
        "skuToUse": "f5-bigiq-virtual-edition-byol",
        "offerToUse": "f5-big-iq",
        "imagePlan": {
            "name": "[variables('skuToUse')]",
            "product": "[variables('offerToUse')]",
            "publisher": "f5-networks"
        },
        "imageReference": {
            "offer": "[variables('offerToUse')]",
            "publisher": "f5-networks",
            "sku": "[variables('skuToUse')]",
            "version": "[parameters('bigIqVersion')]"
        },
        "instanceName": "[toLower(parameters('instanceName'))]",
        "newAvailabilitySetName": "[concat(variables('dnsLabel'), '-avset')]",
        "availabilitySetName": "[replace(parameters('avSetChoice'), 'CREATE_NEW', variables('newAvailabilitySetName'))]",
        "virtualNetworkName": "[parameters('vnetName')]",
        "vnetId": "[resourceId(parameters('vnetResourceGroupName'),'Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]",
        "publicIPAddressType": "Static",
        "mgmtPublicIPAddressName": "[concat(variables('dnsLabel'), '-mgmt-pip')]",
        "mgmtPublicIPAddressId": "[resourceId('Microsoft.Network/publicIPAddresses', variables('mgmtPublicIPAddressName'))]",
        "mgmtNsgID": "[resourceId('Microsoft.Network/networkSecurityGroups/',concat(variables('dnsLabel'),'-mgmt-nsg'))]",
        "mgmtNicName": "[concat(variables('dnsLabel'), '-mgmt')]",
        "mgmtSubnetName": "[parameters('mgmtSubnetName')]",
        "mgmtSubnetId": "[concat(variables('vnetId'), '/subnets/', variables('mgmtSubnetName'))]",
        "mgmtSubnetPrivateAddress": "[parameters('mgmtIpAddress')]",
        "intNsgID": "[resourceId('Microsoft.Network/networkSecurityGroups/',concat(variables('dnsLabel'),'-int-nsg'))]",
        "intNicName": "[concat(variables('dnsLabel'), '-int')]",
        "intSubnetName": "[parameters('internalSubnetName')]",
        "intSubnetId": "[concat(variables('vnetId'), '/subnets/', variables('intSubnetName'))]",
        "intSubnetPrivateAddress": "[parameters('internalIpAddressRangeStart')]",
        "intSubnetPrivateAddressPrefixArray": "[split(parameters('internalIpAddressRangeStart'), '.')]",
        "intSubnetPrivateAddressPrefix": "[concat(variables('intSubnetPrivateAddressPrefixArray')[0], '.', variables('intSubnetPrivateAddressPrefixArray')[1], '.', variables('intSubnetPrivateAddressPrefixArray')[2], '.')]",
        "intSubnetPrivateAddressSuffixInt": "[int(variables('intSubnetPrivateAddressPrefixArray')[3])]",
        "numberOfInternalIps": "[parameters('numberOfInternalIps')]",
        "tagValues": "[parameters('tagValues')]",
        "newDataStorageAccountName": "[concat(uniqueString(variables('dnsLabel'), resourceGroup().id, deployment().name), 'data000')]",
        "dataStorageAccountType": "Standard_LRS",
        "deploymentId": "[concat(variables('subscriptionId'), resourceGroup().id, deployment().name, variables('dnsLabel'))]",
        "customImage": "[replace(parameters('customImage'), 'OPTIONAL', '')]",
        "useCustomImage": "[not(empty(variables('customImage')))]",
        "createNewCustomImage": "[contains(variables('customImage'), 'https://')]",
        "newCustomImageName": "[concat(variables('dnsLabel'), 'image')]",
        "storageProfileArray": {
            "customImage": {
                "imageReference": {
                    "id": "[if(variables('createNewCustomImage'), resourceId('Microsoft.Compute/images', variables('newCustomImageName')), variables('customImage'))]"
                }
            },
            "platformImage": {
                "imageReference": "[variables('imageReference')]",
                "osDisk": {
                    "createOption": "FromImage"
                }
            }
        },
        "premiumInstanceArray": [
            "Standard_DS2",
            "Standard_DS3",
            "Standard_DS4",
            "Standard_DS11",
            "Standard_DS12",
            "Standard_DS13",
            "Standard_DS14",
            "Standard_DS2_v2",
            "Standard_DS3_v2",
            "Standard_DS4_v2",
            "Standard_DS5_v2",
            "Standard_DS11_v2",
            "Standard_DS12_v2",
            "Standard_DS13_v2",
            "Standard_DS14_v2",
            "Standard_DS15_v2",
            "Standard_F2S",
            "Standard_F4S",
            "Standard_F8S",
            "Standard_F16S",
            "Standard_GS2",
            "Standard_GS3",
            "Standard_GS4",
            "Standard_GS5"
        ],
        "initScript": "IyEvYmluL2Jhc2gKCiMjIyBDb25maWd1cmUgZGVmYXVsdCB2YWx1ZXMKbG9nX2xldmVsPSJpbmZvIgpoZWxwPWZhbHNlCnNraXBfdmVyaWZ5PWZhbHNlCnNjcmlwdF9kaXI9JChkaXJuYW1lICQwKQoKVE1TSD0vdXNyL2Jpbi90bXNoCkNVUkw9L3Vzci9iaW4vY3VybApOT0RFPS91c3IvYmluL25vZGUKCiMjIyBGdW5jdGlvbnMgLSBUaGVzZSBzaG91bGQgZ28gaW50byBzZXBlcmF0ZSBmaWxlKHMpCiMgdXNhZ2U6IGxvZyBtZXNzYWdlCmZ1bmN0aW9uIGxvZygpIHsKICAgIGVjaG8gIiQoZGF0ZSAnKyVZLSVtLSVkVCVIOiVNOiVTWicpOiAkMSIKfQojIHVzYWdlOiBnZXRfdmVyc2lvbgpmdW5jdGlvbiBnZXRfdmVyc2lvbigpIHsKICAgIHJldD0kKCRUTVNIIHNob3cgc3lzIHZlcnNpb24gfCBncmVwIC1pIHByb2R1Y3QgfCBhd2sgJ3twcmludCAkMn0nKQogICAgZWNobyAke3JldCwsfQp9CiMgdXNhZ2U6IGpzb25pZnkga2V5OnZhbHVlLGtleTE6dmFsdWUxCmZ1bmN0aW9uIGpzb25pZnkoKSB7CiAgICBsaXN0PSQoZWNobyAkMSB8IHRyICcsJyAnICcpCiAgICBqc29uPSd7fScKICAgIGZvciBpIGluICRsaXN0IDsgZG8KICAgICAgICBrdj0oJChlY2hvICRpIHwgdHIgJzonICcgJykpCiAgICAgICAganNvbj0kKGVjaG8gJGpzb24gfCBqcSAtLWFyZyBrICR7a3ZbMF19IC0tYXJnIHYgJHtrdlsxXX0gJy4gfCAuWyRrXT0kdicpCiAgICBkb25lCiAgICBlY2hvICRqc29uCn0KIyB1c2FnZTogZ2V0X3ZhbCBqc29uX29iamVjdCBrZXkKZnVuY3Rpb24gZ2V0X3ZhbCgpIHsKICAgIHJldD0kKGVjaG8gJDEgfCBqcSAuJDIgLXIpCiAgICBlY2hvICRyZXQKfQojIHVzYWdlOiBtYWtlIHN1cmUgdGhlcmUgaXMgaW50ZXJuZXQgY29ubmVjdGlvbiB0byBHaXRIdWIKZnVuY3Rpb24gY2hlY2tfaW50ZXJuZXRfY29ubmVjdGlvbiB7CiAgICBlY2hvICItLS0gQ2hlY2tpbmcgR2l0aHViIHN0YXR1cyAtLS0iCiAgICBjaGVja3M9MAogICAgZ2l0aHViX3Jlc3BvbnNlPSJiYWQiCiAgICB3aGlsZSBbICRjaGVja3MgLWx0IDEyMCBdIDsgZG8KICAgICAgICBnaXRodWJfcmVzcG9uc2U9YGN1cmwgaHR0cHM6Ly9zdGF0dXMuZ2l0aHViLmNvbS9hcGkvc3RhdHVzLmpzb24/Y2FsbGJhY2stYXBpU3RhdHVzIHwganEgLnN0YXR1cyAtLXJhdy1vdXRwdXRgCiAgICAgICAgaWYgWyAkZ2l0aHViX3Jlc3BvbnNlID09ICJnb29kIiBdOyB0aGVuCiAgICAgICAgICAgIGxvZyAiR2l0SHViIGlzIHJlYWR5IgogICAgICAgICAgICBicmVhawogICAgICAgIGZpCiAgICAgICAgbG9nICJHaXRIdWIgbm90IHJlYWR5OiAkY2hlY2tzIgogICAgICAgIGxldCBjaGVja3M9Y2hlY2tzKzEKICAgICAgICBzbGVlcCA1CiAgICBkb25lCiAgICBpZiBbICRnaXRodWJfcmVzcG9uc2UgPT0gImJhZCIgXTsgdGhlbgogICAgICAgIGxvZyAiTm8gR2l0SHViIGludGVybmV0IGNvbm5lY3Rpb24uIgogICAgICAgIGV4aXQKICAgIGZpCn0KIyB1c2FnZTogbWNwX3J1bm5pbmcKZnVuY3Rpb24gbWNwX3J1bm5pbmcgewogICAgY2hlY2tzPTAKICAgIHdoaWxlIFsgJGNoZWNrcyAtbHQgMTIwIF0gOyBkbwogICAgICAgICRUTVNIIC1hIHNob3cgc3lzIG1jcC1zdGF0ZSBmaWVsZC1mbXQgfCBncmVwIC1xIHJ1bm5pbmcKICAgICAgICBpZiBbICQ/ID09IDAgXTsgdGhlbgogICAgICAgICAgICBsb2cgIk1DUEQgcmVhZHkiCiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgZmkKICAgICAgICBsb2cgIk1DUEQgbm90IHJlYWR5OiAkY2hlY2tzIgogICAgICAgIGxldCBjaGVja3M9Y2hlY2tzKzEKICAgICAgICBzbGVlcCA1CiAgICBkb25lCn0KIyB1c2FnZTogRG93bmxvYWQgZnJvbSBHaXRodWIgdW50aWwgc3VjY2Vzc2Z1bAojCiMgJDE6IG91dHB1dCBmaWxlIG5hbWUKIyAkMjogVVJMCmZ1bmN0aW9uIHNhZmVfZG93bmxvYWQgewogICAgY2hlY2tzPTAKICAgIHdoaWxlIFsgJGNoZWNrcyAtbHQgMTIwIF0gOyBkbwogICAgICAgICRDVVJMIC0tZmFpbCAtLXJldHJ5IDIwIC0tcmV0cnktZGVsYXkgNSAtLXJldHJ5LW1heC10aW1lIDI0MCAtbyAkMSAkMiAmJiBicmVhawogICAgICAgIGxldCBjaGVja3M9Y2hlY2tzKzEKICAgICAgICBzbGVlcCA1CiAgICBkb25lCn0KIyB1c2FnZTogYmFzZV9jb25maWdfYXZhaWxhYmxlIC0gcmVzb2x2ZXMgaXNzdWUgZm91bmQgaW4gNi4wLjAgdmVyc2lvbnMgb2YgYmlnLWlxCmZ1bmN0aW9uIGJhc2VfY29uZmlnX2F2YWlsYWJsZSB7CiAgICBjaGVja3M9MAogICAgd2hpbGUgWyAkY2hlY2tzIC1sdCAxMjAgXSA7IGRvCiAgICAgICAgJFRNU0ggLWEgc2hvdyBzeXMgbWNwLXN0YXRlIGZpZWxkLWZtdCB8IGdyZXAgLXEgcnVubmluZwogICAgICAgIGlmIFsgLWYgL2NvbmZpZy9iaWdpcF9iYXNlLmNvbmYgXTsgdGhlbgogICAgICAgICAgICBsb2cgIkJhc2UgQ29uZmlnIGZpbGUgcHJlc2VudDsgc2F2aW5nIGNvbmZpZyIKICAgICAgICAgICAgdG1zaCBzYXZlIHN5cyBjb25maWcKICAgICAgICAgICAgY2F0IC9jb25maWcvYmlnaXBfYmFzZS5jb25mCiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgZmkKICAgICAgICBsb2cgIkJhc2UgY29uZmlnIGZpbGUgbm90IHlldCBwcmVzZW50OiAkY2hlY2tzIgogICAgICAgIGxldCBjaGVja3M9Y2hlY2tzKzEKICAgICAgICBzbGVlcCA1CiAgICBkb25lCn0KIyB1c2FnZTogZ2V0X25ldF9pbmZvIGV0aDAgbnN8Z3cgaW5jbHVkZV9jaWRyCmZ1bmN0aW9uIGdldF9uZXRfaW5mbygpIHsKICAgIFJFVD0iIgogICAgQ0lEUl9CTE9DSz0iIgogICAgaWYgW1sgJGNsb3VkID09ICJhenVyZSIgXV07IHRoZW4KICAgICAgICBhZGRfaW50PTEKICAgICAgICBJRl9NQUM9JChpZmNvbmZpZyAkMSB8IGdyZXAgLWkgaHdhZGRyIHwgYXdrICd7cHJpbnQgJDV9JyB8IHNlZCAncy86Ly9nJykKICAgICAgICBJRl9JTkZPPSQoY3VybCAtc2YgLS1yZXRyeSAyMCBjdXJsIC1IIE1ldGFkYXRhOnRydWUgImh0dHA6Ly8xNjkuMjU0LjE2OS4yNTQvbWV0YWRhdGEvaW5zdGFuY2UvbmV0d29yay9pbnRlcmZhY2U/YXBpLXZlcnNpb249MjAxNy0wOC0wMSIgfCBqcSAnLltdIHwgc2VsZWN0KC5tYWNBZGRyZXNzPT0iJyR7SUZfTUFDfSciKScpCiAgICAgICAgQ0lEUl9CTE9DSz0kKGVjaG8gJHtJRl9JTkZPfSB8IGpxIC5pcHY0LnN1Ym5ldFswXS5hZGRyZXNzIC0tcmF3LW91dHB1dCkKICAgICAgICBDSURSX0JMT0NLKz0iLyIKICAgICAgICBDSURSX0JMT0NLKz0kKGVjaG8gJHtJRl9JTkZPfSB8IGpxIC5pcHY0LnN1Ym5ldFswXS5wcmVmaXggLS1yYXctb3V0cHV0KQogICAgZWxpZiBbWyAkY2xvdWQgPT0gImF3cyIgXV07IHRoZW4KICAgICAgICBjaWRyX2Jsb2NrX3VyaT0idnBjLWlwdjQtY2lkci1ibG9jayIKICAgICAgICBhZGRfaW50PTIKICAgICAgICAjIElmIGdldHRpbmcgZ2F0ZXdheSwgdXBkYXRlIG5lY2Vzc2FyeSB2YXJzCiAgICAgICAgaWYgW1sgJDIgPT0gImd3IiBdXSA7IHRoZW4gY2lkcl9ibG9ja191cmk9InN1Ym5ldC1pcHY0LWNpZHItYmxvY2siIDsgYWRkX2ludD0xIDsgZmkKICAgICAgICBJRl9NQUM9JChpZmNvbmZpZyAkMSB8IGdyZXAgLWkgaHdhZGRyIHwgYXdrICd7cHJpbnQgdG9sb3dlcigkNSl9JykKICAgICAgICBDSURSX0JMT0NLPSQoY3VybCAtc2YgLS1yZXRyeSAyMCBodHRwOi8vMTY5LjI1NC4xNjkuMjU0L2xhdGVzdC9tZXRhLWRhdGEvbmV0d29yay9pbnRlcmZhY2VzL21hY3MvJHtJRl9NQUN9LyR7Y2lkcl9ibG9ja191cml9KQogICAgZmkKICAgIFJFVD0kKGVjaG8gJHtDSURSX0JMT0NLJS8qfSB8IGF3ayAtRi4gJ3sgcHJpbnRmICIlZC4lZC4lZC4lZCIsICQxLCAkMiwgJDMsICQ0Kycke2FkZF9pbnR9JyB9JykKICAgICMgSW5jbHVkZSBtYXNrIGluIHJlc3BvbnNlIGlmIHJlcXVlc3RlZAogICAgaWYgW1sgLW4gIiQzIiBdXSA7IHRoZW4gZWNobyAke1JFVH0vJHtDSURSX0JMT0NLIyovfSA7IGVsc2UgZWNobyAkUkVUIDsgZmkKfQoKcmVhZCAtciAtZCAnJyBVU0FHRSA8PCBFT00KICAgIFVzYWdlOiAkMAogICAgICAgIC0taGVscCAgICAgICAgICAgICAgICAgICAgICBQcmludCB1c2FnZSBtZXNzYWdlIGFuZCBleGl0CiAgICAgICAgLS1sb2ctbGV2ZWwgPHN0cmluZz4gICAgICAgIExldmVsIG9mIGxvZ2dpbmcgZGVzaXJlZDogZXJyb3IsIHdhcm4sIGluZm8sIGRlYnVnCiAgICAgICAgLS1jbG91ZCA8c3RyaW5nPiAgICAgICAgICAgIENsb3VkIGVudmlyb25tZW50IGV4ZWN1dGVkIGFnYWluc3Q6IGF3cwogICAgICAgIC0tc2tpcC12ZXJpZnkgPHN0cmluZz4gICAgICBTa2lwIHZlcmlmaWNhdGlvbiBvZiBkZXBlbmRlbmNpZXMKICAgICAgICAtLWxpY2Vuc2UgPHN0cmluZz4gICAgICAgICAgTGljZW5zZSBmb3IgdGhlIGRldmljZQogICAgICAgIC0tbnRwIDxzdHJpbmc+ICAgICAgICAgICAgICBOVFAgZm9yIHRoZSBkZXZpY2UKICAgICAgICAtLXRpbWV6b25lIDxzdHJpbmc+ICAgICAgICAgVGltZXpvbmUgZm9yIHRoZSBkZXZpY2UKICAgICAgICAtLWRhdGEtaW50ZXJmYWNlIDxzdHJpbmc+ICAgUHJpbWFyeSBpbnRlcmZhY2UgdG8gdXNlIGZvciBkYXRhLXBsYW5lCiAgICAgICAgLS12bGFuIDxzdHJpbmc+ICAgICAgICAgICAgIFZMQU4ocykgdG8gY3JlYXRlIG9uIHRoZSBkZXZpY2UgKDsgZm9yIG11bHRpcGxlKSAnbjpleHQsbmljOjEuMScKICAgICAgICAtLXNlbGYtaXAgPHN0cmluZz4gICAgICAgICAgU2VsZiBJUChzKSB0byBjcmVhdGUgb24gdGhlIGRldmljZSAoOyBmb3IgbXVsdGlwbGUpOiAnbjpleHQsYTp4LngueC54LHY6ZXh0LGk6ZXRoMScKICAgICAgICAtLXVzYWdlLWFuYWx5dGljcyA8c3RyaW5nPiAgVXNhZ2UgYW5hbHl0aWNzIHRvIHNlbmQ6ICdjTjp2YWwscjp2YWwsY0k6dmFsLGRJOnZhbCxsVDp2YWwsYklWOnZhbCx0Tjp2YWwsdFY6dmFsLHNlbmQ6eWVzJwogICAgICAgIC0tY3JlYXRlLWxpY2Vuc2UtcG9vbCAgICAgICBDcmVhdGVzIGxpY2Vuc2UgcG9vbCwgc2VuZDogbmFtZTpyZWdfa2V5CiAgICAgICAgLS1jcmVhdGUtcmVnLWtleS1wb29sICAgICAgIENyZWF0ZXMgYSByZWdrZXkgcG9vbCwgc2VuZDogbmFtZTpyZWdfa2V5X2xpc3QKICAgICAgICAtLWZjbC10YWcgICAgICAgICAgICAgICAgICAgRjUgY2xvdWQgbGliIHRhZyB0byBkb3dubG9hZCBmNS1jbG91ZC1saWJzLnRhci5negogICAgICAgIC0tZmNsLWNsb3VkLXRhZyAgICAgICAgICAgICBGNSBzcGVjaWZpZWQgY2xvdWQgdGFnIHRvIGRvd25sb2FkIGY1LWNsb3VkLWxpYnMtPGNsb3VkPi50YXIuZ3oKICAgICAgICAtLWJpZy1pcS1wYXNzd29yZC1kYXRhLXVyaSAgVVJJIHRvIHRoZSBsb2NhdGlvbiB0aGF0IGNvbnRhaW5zIEJJRy1JUSBhZG1pbiB1c2VyIHBhc3N3b3JkCiAgICAgICAgLS1tYXN0ZXIgICAgICAgICAgICAgICAgICAgIEluZGljYXRlcyB0aGF0IHRoaXMgaW5zdGFuY2UgaXMgbWFzdGVyICh1c2VkIGluIEJJRy1JUSBjbHVzdGVyaW5nKSB1c2Ugd2l0aCAtLWJpZy1pcS1mYWlsb3Zlci1wZWVyLWlwIG9wdGlvbgogICAgICAgIC0tYmlnLWlxLWZhaWxvdmVyLXBlZXItaXAgICBUaGlzIGlzIHRoZSBwcml2YXRlIElQIGFkZHJlc3MgZm9yIHRoZSBzZWNvbmRhcnkgQklHLUlRCgpFT00KCiMjIyBQYXJzZSBjb21tYW5kIGxpbmUgYXJndW1lbnRzCndoaWxlIFtbICQjIC1ndCAwIF1dIDsgZG8KICAgIGNhc2UgIiQxIiBpbgogICAgICAgIC0taGVscCkKICAgICAgICAgICAgaGVscD10cnVlCiAgICAgICAgICAgIHNoaWZ0IDs7CiAgICAgICAgLS1sb2ctbGV2ZWwpCiAgICAgICAgICAgIGxvZ19sZXZlbD0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLWNsb3VkKQogICAgICAgICAgICBjbG91ZD0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLXNraXAtdmVyaWZ5KQogICAgICAgICAgICBza2lwX3ZlcmlmeT10cnVlCiAgICAgICAgICAgIHNoaWZ0IDs7CiAgICAgICAgLS1saWNlbnNlKQogICAgICAgICAgICBsaWNlbnNlPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tbnRwKQogICAgICAgICAgICBudHA9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS10aW1lem9uZSkKICAgICAgICAgICAgdGltZXpvbmU9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS1kYXRhLWludGVyZmFjZSkKICAgICAgICAgICAgZGF0YV9pbnRlcmZhY2U9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS11c2FnZS1hbmFseXRpY3MpCiAgICAgICAgICAgIHVzYWdlX2FuYWx5dGljcz0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDs7CiAgICAgICAgLS12bGFuKQogICAgICAgICAgICB2bGFuPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tc2VsZi1pcCkKICAgICAgICAgICAgc2VsZl9pcD0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLWRpc2NvdmVyeS1hZGRyZXNzKQogICAgICAgICAgICBkaXNjb3ZlcnlfYWRkcmVzcz0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLWNyZWF0ZS1saWNlbnNlLXBvb2wpCiAgICAgICAgICAgIGxpY2Vuc2VfcG9vbD0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLWNyZWF0ZS1yZWcta2V5LXBvb2wpCiAgICAgICAgICAgIHJlZ19rZXlfcG9vbD0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLWZjbC10YWcpCiAgICAgICAgICAgIGZjbF90YWc9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS1mY2wtY2xvdWQtdGFnKQogICAgICAgICAgICBmY2xfY2xvdWRfdGFnPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tYmlnLWlxLXBhc3N3b3JkLWRhdGEtdXJpKQogICAgICAgICAgICBwYXNzd29yZF9kYXRhX3VyaT0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLW1hc3RlcikKICAgICAgICAgICAgbWFzdGVyPXRydWUKICAgICAgICAgICAgc2hpZnQgOzsKICAgICAgICAtLWJpZy1pcS1mYWlsb3Zlci1wZWVyLWlwKQogICAgICAgICAgICBiaWdfaXFfZmFpbG92ZXJfcGVlcl9pcD0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAqfC0tKQogICAgICAgICAgICBzaGlmdAogICAgICAgICAgICBicmVhayA7OwogICAgZXNhYwpkb25lCgppZiAkaGVscCA7IHRoZW4KICAgIGVjaG8gIiRVU0FHRSIKICAgIGV4aXQKZmkKCiMgVmVyaWZ5IHJlcXVpcmVkIHBhcmFtZXRlcnMKcmVxdWlyZWQ9KCJjbG91ZCIpCmZvciBpIGluICR7cmVxdWlyZWRbQF19IDsgZG8KICAgIGlmIFsgLXogJHshaX0gXSA7IHRoZW4KICAgICAgICBsb2cgIkEgcmVxdWlyZWQgcGFyYW1ldGVyIGlzIG1pc3Npbmc6ICRpIgogICAgICAgIGV4aXQKICAgIGZpCmRvbmUKCmNvbmZpZ19wYXJhbXMgPSAiLS1oZWxwICRoZWxwIC0tbG9nLWxldmVsICRsb2dfbGV2ZWwgLS1jbG91ZCAkY2xvdWQgLS1za2lwLXZlcmlmeSAkc2tpcF92ZXJpZnkgLS1saWNlbnNlICRsaWNlbnNlIC0tbnRwICRudHAgLS10aW1lem9uZSAkdGltZXpvbmUgIC0tZGF0YS1pbnRlcmZhY2UgJGRhdGFfaW50ZXJmYWNlIC0tdXNhZ2UtYW5hbHl0aWNzICR1c2FnZV9hbmFseXRpY3MgLS12bGFuICR2bGFuIC0tc2VsZi1pcCAkc2VsZl9pcCAtLWRpc2NvdmVyeS1hZGRyZXNzICRkaXNjb3ZlcnlfYWRkcmVzcyAtLWNyZWF0ZS1saWNlbnNlLXBvb2wgJGxpY2Vuc2VfcG9vbCAtLWNyZWF0ZS1yZWcta2V5LXBvb2wgJHJlZ19rZXlfcG9vbCAtLWZjbC10YWcgJGZjbF90YWcgLS1mY2wtY2xvdWQtdGFnICRmY2xfY2xvdWRfdGFnIC0tYmlnLWlxLXBhc3N3b3JkLWRhdGEtdXJpICRwYXNzd29yZF9kYXRhX3VyaSIKCmlmIFsgLW4gJG1hc3RlciBdIDsgdGhlbgogICAgY29uZmlnX3BhcmFtcys9ICIgLS1tYXN0ZXIgJG1hc3RlciAiCmZpCmlmIFsgLW4gJGJpZ19pcV9mYWlsb3Zlcl9wZWVyX2lwIF0gOyB0aGVuCiAgICBjb25maWdfcGFyYW1zKz0gIiAtLWJpZy1pcS1mYWlsb3Zlci1wZWVyLWlwICRiaWdfaXFfZmFpbG92ZXJfcGVlcl9pcCAiCmZpCgplY2hvICJDb25maWd1cmF0aW9uIHBhcmFtZXRlcnM6ICRjb25maWdfcGFyYW1zIgoKIyBDaGVjayBmb3IgIkRvIE5vdCBDcmVhdGUiIGluIGNyZWF0ZSBwb29sIHBhcm1ldGVycwpzaG9wdCAtcyBub2Nhc2VtYXRjaAppZiBbWyAkbGljZW5zZV9wb29sID09ICJEb19Ob3RfQ3JlYXRlIiBdXSA7IHRoZW4KICAgIGxvZyAiU2V0dGluZyBsaWNlbnNpbmcgcG9vbCB0byBudWxsIGFzICdEb19Ob3RfQ3JlYXRlJyBoYXMgYmVlbiBzcGVjaWZpZWQ6ICRsaWNlbnNpbmdfcG9vbCIKICAgIGxpY2Vuc2VfcG9vbD0iIgpmaQppZiBbWyAkcmVnX2tleV9wb29sID09ICJEb19Ob3RfQ3JlYXRlIiBdXSA7IHRoZW4KICAgIGxvZyAiU2V0dGluZyByZWcga2V5IHBvb2wgdG8gbnVsbCBhcyAnRG9fTm90X0NyZWF0ZScgaGFzIGJlZW4gc3BlY2lmaWVkOiAkbGljZW5zaW5nX3Bvb2wiCiAgICByZWdfa2V5X3Bvb2w9IiIKZmkKc2hvcHQgLXUgbm9jYXNlbWF0Y2gKCiMjIyBJbnN0YWxsIGRlcGVuZGVuY2llcyAjIyMKIyMgVGhlcmUgbXVzdCBiZSBHaXRIdWIgaW50ZXJuZXQgY29ubmVjdGlvbgpjaGVja19pbnRlcm5ldF9jb25uZWN0aW9uCgpiYXNlX3VybD0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0Y1TmV0d29ya3MiCmJhc2VfZGlyPSIvY29uZmlnL2Nsb3VkIgpiYXNlX2xvZ19kaXI9Ii92YXIvbG9nL2Nsb3VkLyR7Y2xvdWR9IgpiYXNlX2RlcGVuZGVuY3lfZGlyPSIke2Jhc2VfZGlyfS8ke2Nsb3VkfS9ub2RlX21vZHVsZXMvQGY1ZGV2Y2VudHJhbCIKCiMjIERvd25sb2FkCmRlcGVuZGVuY2llcz0oIiR7YmFzZV91cmx9L2Y1LWNsb3VkLWxpYnMvJHtmY2xfdGFnfS9kaXN0L2Y1LWNsb3VkLWxpYnMudGFyLmd6IikKZGVwZW5kZW5jaWVzKz0oIiR7YmFzZV91cmx9L2Y1LWNsb3VkLWxpYnMtJHtjbG91ZH0vJHtmY2xfY2xvdWRfdGFnfS9kaXN0L2Y1LWNsb3VkLWxpYnMtJHtjbG91ZH0udGFyLmd6IikKZGVwZW5kZW5jaWVzKz0oIiR7YmFzZV91cmx9L2Y1LWNsb3VkLWxpYnMvJHtmY2xfdGFnfS9kaXN0L3ZlcmlmeUhhc2giKQoKZm9yIGkgaW4gJHtkZXBlbmRlbmNpZXNbQF19IDsgZG8KICAgIGxvZyAiRG93bmxvYWRpbmcgZGVwZW5kZW5jeTogJGkiCiAgICBmPSQoYmFzZW5hbWUgJGkpCiAgICBzYWZlX2Rvd25sb2FkICR7YmFzZV9kaXJ9LyRmICRpCiAgICAjICRDVVJMIC1rc2YgLS1yZXRyeSAxMCAtLXJldHJ5LWRlbGF5IDUgLS1yZXRyeS1tYXgtdGltZSAyNDAgLW8gJHtiYXNlX2Rpcn0vJGYgJGkKZG9uZQoKIyMgVmVyaWZ5CiMgTUNQIG11c3QgYmUgcnVubmluZyBmaXJzdAptY3BfcnVubmluZwpiYXNlX2NvbmZpZ19hdmFpbGFibGUKCmlmICEgJHNraXBfdmVyaWZ5IDsgdGhlbgogICAgdmVyaWZ5X3NjcmlwdD0iJHtiYXNlX2Rpcn0vdmVyaWZ5SGFzaCIKICAgIGlmICEgJFRNU0ggbG9hZCBzeXMgY29uZmlnIG1lcmdlIGZpbGUgJHZlcmlmeV9zY3JpcHQgOyB0aGVuCiAgICAgICAgbG9nICJDTEkgdmVyaWZpY2F0aW9uIHNjcmlwdCBpcyBub3QgdmFsaWQ6ICR2ZXJpZnlfc2NyaXB0IgogICAgICAgIGV4aXQgMQogICAgZmkKCiAgICBmb3IgaSBpbiAke2RlcGVuZGVuY2llc1tAXX0gOyBkbwogICAgICAgIGY9JChiYXNlbmFtZSAkaSkKICAgICAgICBpZiBbWyAkZiAhPSAidmVyaWZ5SGFzaCIgXV0gOyB0aGVuCiAgICAgICAgICAgIGxvZyAiVmVyaWZ5aW5nIGRlcGVuZGVuY3k6ICRmIgogICAgICAgICAgICBpZiAhICRUTVNIIHJ1biBjbGkgc2NyaXB0IHZlcmlmeUhhc2ggIi9jb25maWcvY2xvdWQvJGYiIDsgdGhlbgogICAgICAgICAgICAgICAgbG9nICJEZXBlbmRlbmN5IGlzIG5vdCB2YWxpZDogJGYiCiAgICAgICAgICAgICAgICBleGl0IDEKICAgICAgICAgICAgZmkKICAgICAgICBmaQogICAgZG9uZQplbHNlCiAgICBsb2cgIldhcm5pbmc6IFNraXBwaW5nIGRlcGVuZGVuY3kgdmVyaWZpY2F0aW9uIgpmaQoKIyMgSW5zdGFsbApta2RpciAtcCAkYmFzZV9kZXBlbmRlbmN5X2Rpcgpmb3IgaSBpbiAke2RlcGVuZGVuY2llc1tAXX0gOyBkbwogICAgZj0kKGJhc2VuYW1lICRpKQogICAgbG9nICJJbnN0YWxsaW5nIGRlcGVuZGVuY3k6ICRmIgogICAgaWYgW1sgJGYgPT0gKiIudGFyIiogXV0gOyB0aGVuCiAgICAgICAgdGFyIHhmeiAke2Jhc2VfZGlyfS8ke2Z9IC1DICRiYXNlX2RlcGVuZGVuY3lfZGlyCiAgICBmaQpkb25lCgojIyBTaWduYWwKdG91Y2ggIiR7YmFzZV9kaXJ9L2Nsb3VkTGlic1JlYWR5IgoKIyMjIFByb3Zpc2lvbiBEZXZpY2UgIyMjCm1rZGlyIC1wICRiYXNlX2xvZ19kaXIKaG9zdG5hbWU9IiIKaWYgW1sgJGNsb3VkID09ICJhd3MiIF1dOyB0aGVuCiAgICBob3N0bmFtZT0kKCRDVVJMIC1zZiAtLXJldHJ5IDIwIGh0dHA6Ly8xNjkuMjU0LjE2OS4yNTQvbGF0ZXN0L21ldGEtZGF0YS9ob3N0bmFtZSkKZWxpZiBbWyAkY2xvdWQgPT0gImF6dXJlIiBdXTsgdGhlbgogICAgbWV0YWRhdGE9JCgkQ1VSTCAtSCBNZXRhZGF0YTp0cnVlICJodHRwOi8vMTY5LjI1NC4xNjkuMjU0L21ldGFkYXRhL2luc3RhbmNlL2NvbXB1dGU/YXBpLXZlcnNpb249MjAxNy0xMi0wMSIpCiAgICBob3N0bmFtZT0kKGVjaG8gJHttZXRhZGF0YX0gfCBqcSAubmFtZSAtLXJhdy1vdXRwdXQpCiAgICBob3N0bmFtZSs9Ii4iCiAgICBob3N0bmFtZSs9JChlY2hvICR7bWV0YWRhdGF9IHwganEgLmxvY2F0aW9uIC0tcmF3LW91dHB1dCkKICAgIGhvc3RuYW1lKz0iLmNsb3VkYXBwLmF6dXJlLmNvbSIKZmkKaG9zdD0ibG9jYWxob3N0IgpzZXBhcmF0b3I9IjsiCgojIENvdWxkIHVzZSBhIGdlbmVyaWMgLS1vbmJvYXJkfC0tbmV0d29ya3xldGMgZm9yIG9wdGlvbmFsIGFyZ3VtZW50cwojIGluc3RlYWQsIGF0IGxlYXN0IGZvciBub3cgaW1wbGVtZW50IHRoZSBhZGRpdGlvbmFsIGFic3RyYWN0aW9uCgojIyBPbmJvYXJkCm9uYm9hcmRfYXJncz0iIgppZiBbIC1uICIkY2xvdWQiIF0gOyB0aGVuIG9uYm9hcmRfYXJncys9Ii0tY2xvdWQgJHtjbG91ZH0gIiA7IGZpCmlmIFsgLW4gIiRsaWNlbnNlIiBdIDsgdGhlbiBvbmJvYXJkX2FyZ3MrPSItLWxpY2Vuc2UgJHtsaWNlbnNlfSAiIDsgZmkKaWYgWyAtbiAiJG50cCIgXSA7IHRoZW4gb25ib2FyZF9hcmdzKz0iLS1udHAgJHtudHB9ICIgOyBmaQppZiBbIC1uICIkdGltZXpvbmUiIF0gOyB0aGVuIG9uYm9hcmRfYXJncys9Ii0tdHogJHt0aW1lem9uZX0gIiA7IGZpCmlmIFsgLW4gIiRsaWNlbnNlX3Bvb2wiIF0gOyB0aGVuCiAgICAjIENoZWNrIGZvciBtdWxpdGlwbGUgbGljZW5zZSBwb29scwogICAgT0lGUz0kSUZTCiAgICBJRlM9IiwiOwogICAgbGljZW5zZUFycmF5PSgkbGljZW5zZV9wb29sKTsKICAgIGZvciBpIGluICR7bGljZW5zZUFycmF5W0BdfTsgZG8KICAgICAgICBmbGFnPScgLS1jcmVhdGUtbGljZW5zZS1wb29sICcKICAgICAgICBjYXRfYXJncz0iJHtjYXRfYXJnc30ke2ZsYWd9JGkiCiAgICBkb25lCiAgICBJRlM9JE9JRlM7CiAgICBvbmJvYXJkX2FyZ3MrPSIke2NhdF9hcmdzfSAiIDsgZmkKCmlmIFsgLW4gIiRyZWdfa2V5X3Bvb2wiIF0gOyB0aGVuIG9uYm9hcmRfYXJncys9Ii0tY3JlYXRlLXJlZy1rZXktcG9vbCAke3JlZ19rZXlfcG9vbH0gIiA7IGZpCgppZiBbWyAkY2xvdWQgPT0gImF3cyIgXV07IHRoZW4KICAgIGlmIFsgLW4gIiRkYXRhX2ludGVyZmFjZSIgXSA7IHRoZW4gb25ib2FyZF9hcmdzKz0iLS1kbnMgJChnZXRfbmV0X2luZm8gJGRhdGFfaW50ZXJmYWNlIG5zKSAiIDsgZmkKZWxpZiBbWyAkY2xvdWQgPT0gImF6dXJlIiBdXTsgdGhlbgogICAgaWYgWyAtbiAiJGRhdGFfaW50ZXJmYWNlIiBdIDsgdGhlbiBvbmJvYXJkX2FyZ3MrPSItLWRucyAxNjguNjMuMTI5LjE2ICIgOyBmaQpmaQoKaWYgW1sgIiQoZ2V0X3ZlcnNpb24pIiA9PSAiYmlnLWlxIiAmJiAtbiAiJHBhc3N3b3JkX2RhdGFfdXJpIiBdXTsgdGhlbgogICAgb25ib2FyZF9hcmdzKz0iLS1iaWctaXEtcGFzc3dvcmQtZGF0YS11cmkgJHtwYXNzd29yZF9kYXRhX3VyaX0gIgplbGlmIFtbICIkKGdldF92ZXJzaW9uKSIgPT0gImJpZy1pcSIgXV07IHRoZW4KICAgIG9uYm9hcmRfYXJncys9Ii0tc2V0LW1hc3Rlci1rZXkgIgpmaQoKaWYgWyAtbiAiJHVzYWdlX2FuYWx5dGljcyIgXSA7IHRoZW4KICAgIG89JChqc29uaWZ5ICR1c2FnZV9hbmFseXRpY3MpCiAgICAjIE9iZnVzY2F0ZSBzZW5zaXRpdmUgaW5mb3JtYXRpb24KICAgIGNJPSQoZWNobyAkKGdldF92YWwgIiRvIiBjSSkgfCBzaGE1MTJzdW0gfCBjdXQgLWQgIiAiIC1mIDEpCiAgICBkST0kKGVjaG8gJChnZXRfdmFsICIkbyIgZEkpIHwgc2hhNTEyc3VtIHwgY3V0IC1kICIgIiAtZiAxKQogICAgbWV0cmljcys9ImNsb3VkTmFtZTokKGdldF92YWwgIiRvIiBjTikscmVnaW9uOiQoZ2V0X3ZhbCAiJG8iIHIpLGN1c3RvbWVySWQ6JHtjSX0iCiAgICBtZXRyaWNzKz0iLGRlcGxveW1lbnRJZDoke2RJfSxsaWNlbnNlVHlwZTokKGdldF92YWwgIiRvIiBsVCksYmlnSXBWZXJzaW9uOiQoZ2V0X3ZhbCAiJG8iIGJJVikiCiAgICBtZXRyaWNzKz0iLHRlbXBsYXRlTmFtZTokKGdldF92YWwgIiRvIiB0TiksdGVtcGxhdGVWZXJzaW9uOiQoZ2V0X3ZhbCAiJG8iIHRWKSAiCiAgICBzZW5kX2FuYWx5dGljcz0kKGdldF92YWwgIiRvIiBzZW5kKQogICAgaWYgW1sgIiR7c2VuZF9hbmFseXRpY3MsLH0iID09ICJ5ZXMiIF1dIDsgdGhlbiBvbmJvYXJkX2FyZ3MrPSItLW1ldHJpY3MgJG1ldHJpY3MgIiA7IGZpCmZpCgokTk9ERSAiJHtiYXNlX2RlcGVuZGVuY3lfZGlyfS9mNS1jbG91ZC1saWJzL3NjcmlwdHMvb25ib2FyZC5qcyIgLS1ob3N0ICRob3N0IC0tbG9nLWxldmVsICRsb2dfbGV2ZWwgXAogICAgLS1vdXRwdXQgIiR7YmFzZV9sb2dfZGlyfS9vbmJvYXJkLmxvZyIgLS1zaWduYWwgT05CT0FSRF9ET05FIC0taG9zdG5hbWUgJGhvc3RuYW1lICRvbmJvYXJkX2FyZ3MgJj4+ICR7YmFzZV9sb2dfZGlyfS9pbnN0YWxsLmxvZwoKIyBUT0RPOiBSYWNlIGNvbmRpdGlvbiBiZXR3ZWVuIG9uYm9hcmQvbmV0d29yayAtIFVzaW5nIGF1dGggdG9rZW4gcmVzdWx0cyBpbiA0MDMgIm5vdCBhdXRob3JpemVkIgojIGlmIG5ldHdvcmsgY2FsbCBpbW1lZGlhdGVseSBmb2xsb3dzIG9uYm9hcmQuICBVc2UgZm9sbG93aW5nIHBsYWNlaG9sZGVyIHVudGlsIGZpeGVkIGluIGY1LWNsb3VkLWxpYnMKIyBhZGRpbmcgLS13YWl0LWZvciBzaWduYWwgZm9yIG5ldHdvcmsgY2FsbC4Kd2FpdF90aW1lPTMwCmxvZyAiV2FpdGluZzogJHdhaXRfdGltZSIKc2xlZXAgJHdhaXRfdGltZQoKIyMgTmV0d29yawplY2hvICJDb25maWd1cmluZyBuZXR3b3JrLi4uIgpuZXR3b3JrX2FyZ3M9IiIKaWYgWyAtbiAiJGRhdGFfaW50ZXJmYWNlIiBdIDsgdGhlbiBuZXR3b3JrX2FyZ3MrPSItLWRlZmF1bHQtZ3cgJChnZXRfbmV0X2luZm8gJGRhdGFfaW50ZXJmYWNlIGd3KSAiIDsgZmkKaWYgWyAtbiAiJHZsYW4iIF0gOyB0aGVuCiAgICBmb3IgaSBpbiAkKGVjaG8gJHZsYW4gfCB0ciAiJHNlcGFyYXRvciIgJyAnKSA7IGRvCiAgICAgICAgbz0kKGpzb25pZnkgJGkpCiAgICAgICAgbmV0d29ya19hcmdzKz0iLS12bGFuIG5hbWU6JChnZXRfdmFsICIkbyIgbiksbmljOiQoZ2V0X3ZhbCAiJG8iIG5pYykgIgogICAgZG9uZQpmaQppZiBbIC1uICIkc2VsZl9pcCIgXSA7IHRoZW4KICAgIGZvciBpIGluICQoZWNobyAkc2VsZl9pcCB8IHRyICIkc2VwYXJhdG9yIiAnICcpIDsgZG8KICAgICAgICBvPSQoanNvbmlmeSAkaSkKICAgICAgICBndz0kKGdldF9uZXRfaW5mbyAkKGdldF92YWwgIiRvIiBpKSBndyBjaWRyKQogICAgICAgIG5ldHdvcmtfYXJncys9Ii0tc2VsZi1pcCBuYW1lOiQoZ2V0X3ZhbCAiJG8iIG4pLGFkZHJlc3M6JChnZXRfdmFsICIkbyIgYSkvJHtndyMqL30sdmxhbjokKGdldF92YWwgIiRvIiB2KSAiCiAgICBkb25lCmZpCmlmIFsgLW4gIiRkaXNjb3ZlcnlfYWRkcmVzcyIgXSA7IHRoZW4KICAgIG5ldHdvcmtfYXJncys9Ii0tZGlzY292ZXJ5LWFkZHJlc3MgJHtkaXNjb3ZlcnlfYWRkcmVzc30iCmZpCiROT0RFICIke2Jhc2VfZGVwZW5kZW5jeV9kaXJ9L2Y1LWNsb3VkLWxpYnMvc2NyaXB0cy9uZXR3b3JrLmpzIiAtLWhvc3QgJGhvc3QgLS1sb2ctbGV2ZWwgJGxvZ19sZXZlbCBcCiAgICAtLW91dHB1dCAiJHtiYXNlX2xvZ19kaXJ9L25ldHdvcmsubG9nIiAtLXdhaXQtZm9yIE9OQk9BUkRfRE9ORSAtLXNpZ25hbCBORVRXT1JLX0RPTkUgJG5ldHdvcmtfYXJncyAmPj4gJHtiYXNlX2xvZ19kaXJ9L2luc3RhbGwubG9nCgojIyBDbHVzdGVyCmlmIFtbIC1uICIkbWFzdGVyIiAmJiAtbiAiJGJpZ19pcV9mYWlsb3Zlcl9wZWVyX2lwIiBdXSA7IHRoZW4KICAgIGVjaG8gIkNvbmZpZ3VyaW5nIGNsdXN0ZXIuLi4iCiAgICBjbHVzdGVyX2FyZ3M9Ii0tY2xvdWQgJGNsb3VkIC0tbWFzdGVyIC0tYmlnLWlxLWZhaWxvdmVyLXBlZXItaXAgJGJpZ19pcV9mYWlsb3Zlcl9wZWVyX2lwIgogICAgaWYgWyAtbiAiJHBhc3N3b3JkX2RhdGFfdXJpIiBdIDsgdGhlbgogICAgICAgIGNsdXN0ZXJfYXJncys9IiAtLWJpZy1pcS1wYXNzd29yZC1kYXRhLXVyaSAkcGFzc3dvcmRfZGF0YV91cmkiCiAgICBmaQogICAgJE5PREUgIiR7YmFzZV9kZXBlbmRlbmN5X2Rpcn0vZjUtY2xvdWQtbGlicy9zY3JpcHRzL2NsdXN0ZXIuanMiIC0taG9zdCAkaG9zdCAtLWxvZy1sZXZlbCAkbG9nX2xldmVsIFwKICAgICAgICAtLW91dHB1dCAiJHtiYXNlX2xvZ19kaXJ9L2NsdXN0ZXIubG9nIiAtLXVzZXIgYWRtaW4gJGNsdXN0ZXJfYXJncyAmPj4gJHtiYXNlX2xvZ19kaXJ9L2luc3RhbGwubG9nCmZpCg==",
        "customConfig": "### START (INPUT) CUSTOM CONFIGURATION HERE\n",
        "installCustomConfig": "[concat(variables('singleQuote'), '#!/bin/bash\n', variables('customConfig'), variables('singleQuote'))]"
    },
    "resources": [
        {
            "apiVersion": "[variables('networkApiVersion')]",
            "location": "[variables('location')]",
            "name": "[variables('mgmtPublicIPAddressName')]",
            "properties": {
                "dnsSettings": {
                    "domainNameLabel": "[variables('dnsLabel')]"
                },
                "idleTimeoutInMinutes": 30,
                "publicIPAllocationMethod": "[variables('publicIPAddressType')]"
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Network/publicIPAddresses"
        },
        {
            "apiVersion": "[variables('networkApiVersion')]",
            "dependsOn": [
                "[variables('mgmtPublicIPAddressId')]",
                "[variables('mgmtNsgID')]"
            ],
            "location": "[variables('location')]",
            "name": "[variables('mgmtNicName')]",
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "[concat(variables('instanceName'), '-ipconfig1')]",
                        "properties": {
                            "PublicIpAddress": {
                                "Id": "[variables('mgmtPublicIPAddressId')]"
                            },
                            "privateIPAddress": "[variables('mgmtSubnetPrivateAddress')]",
                            "privateIPAllocationMethod": "Static",
                            "subnet": {
                                "id": "[variables('mgmtSubnetId')]"
                            }
                        }
                    }
                ],
                "networkSecurityGroup": {
                    "id": "[variables('mgmtNsgID')]"
                }
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Network/networkInterfaces"
        },
        {
            "apiVersion": "[variables('networkApiVersion')]",
            "dependsOn": [
                "[variables('intNsgID')]"
            ],
            "location": "[variables('location')]",
            "name": "[variables('intNicName')]",
            "properties": {
                "copy": [
                    {
                        "count": "[add(variables('numberOfInternalIps'), 1)]",
                        "input": {
                            "name": "[if(equals(copyIndex('ipConfigurations', 1), 1), concat(variables('instanceName'), '-self-ipconfig'), concat(variables('resourceGroupName'), '-int-ipconfig', sub(copyIndex('ipConfigurations', 1), 2)))]",
                            "properties": {
                                "primary": "[if(equals(copyIndex('ipConfigurations', 1), 1), 'True', 'False')]",
                                "privateIPAddress": "[if(equals(copyIndex('ipConfigurations', 1), 1), variables('intSubnetPrivateAddress'), concat(variables('intSubnetPrivateAddressPrefix'), add(variables('intSubnetPrivateAddressSuffixInt'), sub(copyIndex('ipConfigurations', 1), 1))))]",
                                "privateIPAllocationMethod": "Static",
                                "subnet": {
                                    "id": "[variables('intSubnetId')]"
                                }
                            }
                        },
                        "name": "ipConfigurations"
                    }
                ],
                "networkSecurityGroup": {
                    "id": "[concat(variables('intNsgID'))]"
                }
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Network/networkInterfaces"
        },
        {
            "apiVersion": "[variables('networkApiVersion')]",
            "location": "[variables('location')]",
            "name": "[concat(variables('dnsLabel'), '-mgmt-nsg')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "mgmt_allow_https",
                        "properties": {
                            "access": "Allow",
                            "description": "",
                            "destinationAddressPrefix": "*",
                            "destinationPortRange": "443",
                            "direction": "Inbound",
                            "priority": 101,
                            "protocol": "Tcp",
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddress')]",
                            "sourcePortRange": "*"
                        }
                    },
                    {
                        "name": "allow_ssh_22",
                        "properties": {
                            "access": "Allow",
                            "description": "",
                            "destinationAddressPrefix": "*",
                            "destinationPortRange": "22",
                            "direction": "Inbound",
                            "priority": 102,
                            "protocol": "Tcp",
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddress')]",
                            "sourcePortRange": "*"
                        }
                    }
                ]
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Network/networkSecurityGroups"
        },
        {
            "apiVersion": "[variables('networkApiVersion')]",
            "location": "[variables('location')]",
            "name": "[concat(variables('dnsLabel'), '-int-nsg')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "int_allow_https",
                        "properties": {
                            "access": "Allow",
                            "description": "",
                            "destinationAddressPrefix": "*",
                            "destinationPortRange": "443",
                            "direction": "Inbound",
                            "priority": 101,
                            "protocol": "Tcp",
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddressApp')]",
                            "sourcePortRange": "*"
                        }
                    },
                    {
                        "name": "int_allow_ssh_22",
                        "properties": {
                            "access": "Allow",
                            "description": "",
                            "destinationAddressPrefix": "*",
                            "destinationPortRange": "22",
                            "direction": "Inbound",
                            "priority": 102,
                            "protocol": "Tcp",
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddressApp')]",
                            "sourcePortRange": "*"
                        }
                    }
                ]
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Network/networkSecurityGroups"
        },
        {
            "apiVersion": "[variables('computeApiVersion')]",
            "condition": "[equals(toUpper(parameters('avSetChoice')), 'CREATE_NEW')]",
            "location": "[variables('location')]",
            "name": "[variables('availabilitySetName')]",
            "properties": {
                "PlatformFaultDomainCount": 2,
                "PlatformUpdateDomainCount": 2
            },
            "sku": {
                "name": "Aligned"
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Compute/availabilitySets"
        },
        {
            "apiVersion": "[variables('storageApiVersion')]",
            "kind": "Storage",
            "location": "[variables('location')]",
            "name": "[variables('newDataStorageAccountName')]",
            "properties": {
                "supportsHttpsTrafficOnly": true
            },
            "sku": {
                "name": "[variables('dataStorageAccountType')]",
                "tier": "Standard"
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Storage/storageAccounts"
        },
        {
            "apiVersion": "[variables('computeApiVersion')]",
            "condition": "[and(variables('useCustomImage'), variables('createNewCustomImage'))]",
            "location": "[variables('location')]",
            "name": "[variables('newCustomImageName')]",
            "properties": {
                "storageProfile": {
                    "osDisk": {
                        "blobUri": "[variables('customImage')]",
                        "osState": "Generalized",
                        "osType": "Linux",
                        "storageAccountType": "[if(contains(variables('premiumInstanceArray'), parameters('instanceType')), 'Premium_LRS', 'Standard_LRS')]"
                    }
                }
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Compute/images"
        },
        {
            "apiVersion": "[variables('computeApiVersion')]",
            "dependsOn": [
                "[concat('Microsoft.Storage/storageAccounts/', variables('newDataStorageAccountName'))]",
                "[concat('Microsoft.Compute/availabilitySets/', variables('availabilitySetName'))]",
                "[variables('newCustomImageName')]",
                "[concat('Microsoft.Network/networkInterfaces/', variables('mgmtNicName'))]",
                "[concat('Microsoft.Network/networkInterfaces/', variables('intNicName'))]"
            ],
            "location": "[variables('location')]",
            "name": "[variables('instanceName')]",
            "plan": "[if(variables('useCustomImage'), json('null'), variables('imagePlan'))]",
            "properties": {
                "availabilitySet": {
                    "id": "[resourceId('Microsoft.Compute/availabilitySets',variables('availabilitySetName'))]"
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(concat('Microsoft.Storage/storageAccounts/', variables('newDataStorageAccountName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).primaryEndpoints.blob]"
                    }
                },
                "hardwareProfile": {
                    "vmSize": "[parameters('instanceType')]"
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('mgmtNicName'))]",
                            "properties": {
                                "primary": true
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('intNicName'))]",
                            "properties": {
                                "primary": false
                            }
                        }
                    ]
                },
                "osProfile": {
                    "adminPassword": "[variables('adminPasswordOrKey')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "computerName": "[variables('instanceName')]",
                    "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), json('null'), variables('linuxConfiguration'))]"
                },
                "storageProfile": "[if(variables('useCustomImage'), variables('storageProfileArray').customImage, variables('storageProfileArray').platformImage)]"
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Compute/virtualMachines"
        },
        {
            "apiVersion": "[variables('computeApiVersion')]",
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', variables('instanceName'))]"
            ],
            "location": "[variables('location')]",
            "name": "[concat(variables('instanceName'),'/start')]",
            "properties": {
                "protectedSettings": {
                    "commandToExecute": "[concat('mkdir -p /var/log/cloud/azure; mkdir -p /config/cloud; echo ', variables('initScript'), ' | /usr/bin/base64 -d > /config/cloud/init.sh; chmod +x /config/cloud/init.sh;', ' /config/cloud/init.sh --cloud azure --log-level debug --data-interface eth1 --license ', parameters('bigIqLicenseKey1'), ' --ntp ', parameters('ntpServer'), ' --timezone ', parameters('timeZone'), ' --create-license-pool ', parameters('licensePoolKeys'), ' --create-reg-key-pool ', parameters('regPoolKeys'), ' --fcl-tag ', variables('f5CloudLibsTag'), ' --fcl-cloud-tag ', variables('f5CloudLibsAzureTag'), ' --vlan ', variables('singleQuote'), 'n:internal,nic:1.1', variables('singleQuote'), ' --self-ip ', variables('singleQuote'), 'n:internal_self,a:', variables('intSubnetPrivateAddress'), ',v:internal,i:eth1', variables('singleQuote'), ' --usage-analytics ', variables('singleQuote'), 'send:', parameters('allowUsageAnalytics'), ',r:', variables('location'), ',cI:', variables('subscriptionID'), ',dI:', variables('deploymentId'), ',cN:aws,lT:byol,bIV:6.0.0,tN:f5-existing-stack-byol-2nic-bigiq,tV:4.3.0', variables('singleQuote'), ' &>> /var/log/cloud/azure/install.log &')]"
                },
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.0"
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Compute/virtualMachines/extensions"
        }
    ],
    "outputs": {
        "GUI-URL": {
            "type": "string",
            "value": "[concat('https://', reference(variables('mgmtPublicIPAddressId')).dnsSettings.fqdn, ':', 443)]"
        },
        "SSH-URL": {
            "type": "string",
            "value": "[concat(reference(variables('mgmtPublicIPAddressId')).dnsSettings.fqdn, ' ',22)]"
        }
    }
}
