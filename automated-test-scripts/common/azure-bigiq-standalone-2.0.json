{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "5.3.0.0",
    "parameters": {
        "adminUsername": {
            "defaultValue": "azureuser",
            "metadata": {
                "description": "User name for the Virtual Machine."
            },
            "type": "string"
        },
        "adminPassword": {
            "metadata": {
                "description": "Password to login to the Virtual Machine. Note: There are a number of special characters that you should avoid using for F5 product user accounts.  See [K2873](https://support.f5.com/csp/article/K2873) for details."
            }, 
            "type": "securestring"
        }, 
        "authenticationType": {
            "allowedValues": [
                "password",
                "sshPublicKey"
            ],
            "defaultValue": "password",
            "metadata": {
                "description": "Type of authentication to use on the Virtual Machine, password based authentication or key based authentication."
            },
            "type": "string"
        },
        "masterKey": {
            "defaultValue": "34jkcvni389#494kcx@dfkdi9H",
            "metadata": {
                "description": "Specify BIG-IQ master Key."
            }, 
            "type": "securestring"
        },         
        "dnsLabel": {
            "defaultValue": "",
            "metadata": {
                "description": "Unique DNS Name for the Public IP address used to access the Virtual Machine."
            },
            "type": "string"
        },
        "instanceName": {
            "defaultValue": "f5bigiq01",
            "metadata": {
                "description": "Name of the Virtual Machine."
            },
            "type": "string"
        },
        "instanceType": {
            "allowedValues": [
                "Standard_D4s_v3",
                "Standard_D2s_v3",
                "Standard_D8s_v3"
            ],
            "defaultValue": "Standard_D4s_v3",
            "metadata": {
                "description": "Instance size of the Virtual Machine."
            },
            "type": "string"
        },
        "bigIqVersion": {
            "allowedValues": [
                "8.0.001000"
            ],
            "defaultValue": "8.0.001000",
            "metadata": {
                "description": "F5 BIG-IQ version you want to use."
            },
            "type": "string"
        },
        "bigIqLicenseKey1": {
            "defaultValue": "",
            "metadata": {
                "description": "F5 BYOL BIG-IQ License Manager registration key."
            },
            "maxLength": 255,
            "minLength": 1,
            "type": "string"
        },
        "licensePoolKeys": {
            "defaultValue": "Do_Not_Create",
            "metadata": {
                "description": "Enter a pool name and registration key using the format of name:key. Leave Do_Not_Create if you do not want to create a licensing pool on BIG-IQ at this time."
            },
            "maxLength": 255,
            "minLength": 1,
            "type": "string"
        },
        "regPoolKeys": {
            "defaultValue": "Do_Not_Create",
            "metadata": {
                "description": "Enter a pool name and a list of individual BIG-IP registration keys in the format of name:key,key,key. Leave Do_Not_Create if you do not want to create a reg key pool on BIG-IQ at this time."
            },
            "maxLength": 255,
            "minLength": 1,
            "type": "string"
        },
        "numberOfInternalIps": {
            "allowedValues": [
                0,
                1
            ],
            "defaultValue": 1,
            "metadata": {
                "description": "The number of public/private IP addresses you want to deploy for the application traffic (internal) NIC on the BIG-IQ VE to be used for virtual servers."
            },
            "type": "int"
        },
        "vnetName": {
            "defaultValue": "existingStackVnet",
            "metadata": {
                "description": "The name of the existing virtual network to which you want to connect the BIG-IQ VEs."
            },
            "type": "string"
        },
        "vnetResourceGroupName": {
            "metadata": {
                "description": "The name of the resource group that contains the Virtual Network where the BIG-IQ VE will be placed."
            },
            "type": "string"
        },
        "mgmtSubnetName": {
            "defaultValue": "mgmt",
            "metadata": {
                "description": "Name of the existing mgmt subnet - with external access to the Internet. **Important**: The subnet you provide for the mgmt NIC **must** be unique."
            },
            "type": "string"
        },
        "mgmtIpAddress": {
            "defaultValue": "192.168.1.100",
            "metadata": {
                "description": "MGMT subnet IP Address to use for the BIG-IQ management IP address."
            },
            "type": "string"
        },
        "internalSubnetName": {
            "defaultValue": "internal",
            "metadata": {
                "description": "Name of the existing internal subnet. **Important**: The subnet you provide for the internal NIC **must** be unique."
            },
            "type": "string"
        },
        "internalIpAddressRangeStart": {
            "defaultValue": "192.168.2.100",
            "metadata": {
                "description": "The static private IP address want to assign to the first internal Azure public IP (for self IP). An additional private IP address will be assigned for each public IP address you specified in **numberOfInternalIps**.  For example, entering 10.100.1.50 here and choosing 2 in numberOfInternalIps would result in 10.100.1.50 (self IP), 10.100.1.51 and 10.100.1.52 being configured as static private IP addresses for internal virtual servers."
            },
            "type": "string"
        },
        "avSetChoice": {
            "defaultValue": "CREATE_NEW",
            "metadata": {
                "description": "If you want the VM placed in a new Azure Availability Set, leave the default value of **CREATE_NEW**, otherwise specify the name of the existing Availability Set you want to use. Note: If you are using an existing AV Set, this deployment must be in the same Azure Resource Group as the AV Set."
            },
            "type": "string"
        },
        "ntpServer": {
            "defaultValue": "0.pool.ntp.org",
            "metadata": {
                "description": "Leave the default NTP server the BIG-IQ uses, or replace the default NTP server with the one you want to use."
            },
            "type": "string"
        },
        "timeZone": {
            "defaultValue": "UTC",
            "metadata": {
                "description": "If you would like to change the time zone the BIG-IQ uses, enter the time zone you want to use. This is based on the tz database found in /usr/share/zoneinfo (see the full list [here](https://github.com/F5Networks/f5-azure-arm-templates/blob/master/azure-timezone-list.md)). Example values: UTC, US/Pacific, US/Eastern, Europe/London or Asia/Singapore."
            },
            "type": "string"
        },
        "customImage": {
            "defaultValue": "OPTIONAL",
            "metadata": {
                "description": "If you would like to deploy using a local BIG-IQ image, provide either the full URL to the VHD in Azure storage **or** the full resource ID to an existing Microsoft.Compute image resource.  **Note**: Unless specifically required, leave the default of **OPTIONAL**."
            },
            "type": "string"
        },
        "restrictedSrcAddress": {
            "defaultValue": "*",
            "metadata": {
                "description": "Source Address(es) for Management Access. The IP address range used to SSH and access management GUI on the BIG-IQ."
            },
            "type": "string"
        },
        "restrictedSrcAddressApp": {
            "defaultValue": "*",
            "metadata": {
                "description": "Source Address(es) for internal Management Access. The IP address range that can be used to access BIG-IQ on the specified internal network via port 443."
            },
            "type": "string"
        },
        "tagValues": {
            "defaultValue": {
                "application": "dewdrop",
                "cost": "COST",
                "environment": "bigiq",
                "group": "GROUP",
                "owner": "OWNER"
            },
            "metadata": {
                "description": "Default key/value resource tags will be added to the resources in this deployment, if you would like the values to be unique adjust them as needed for each key."
            },
            "type": "object"
        },
        "allowUsageAnalytics": {
            "allowedValues": [
                "Yes",
                "No"
            ],
            "defaultValue": "No",
            "metadata": {
                "description": "This deployment can send anonymous statistics to F5 to help us determine how to improve our solutions. If you select **No** statistics are not sent."
            },
            "type": "string"
        }
    },
    "variables": {
        "computeApiVersion": "2017-12-01",
        "networkApiVersion": "2017-11-01",
        "storageApiVersion": "2017-10-01",
        "location": "[resourceGroup().location]",
        "adminPassword": "[replace(parameters('adminPassword'),'\\n', '\n')]",
        "subscriptionID": "[subscription().subscriptionId]",
        "resourceGroupName": "[resourceGroup().name]",
        "singleQuote": "'",
        "f5CloudLibsTag": "v4.8.1",
        "f5CloudLibsAzureTag": "v2.8.0",
        "dnsLabel": "[toLower(parameters('dnsLabel'))]",
        "skuToUse": "f5-bigiq-virtual-edition-byol",
        "offerToUse": "f5-big-iq",
        "imagePlan": {
            "name": "[variables('skuToUse')]",
            "product": "[variables('offerToUse')]",
            "publisher": "f5-networks"
        },
        "imageReference": {
            "offer": "[variables('offerToUse')]",
            "publisher": "f5-networks",
            "sku": "[variables('skuToUse')]",
            "version": "[parameters('bigIqVersion')]"
        },
        "instanceName": "[toLower(parameters('instanceName'))]",
        "newAvailabilitySetName": "[concat(variables('dnsLabel'), '-avset')]",
        "availabilitySetName": "[replace(parameters('avSetChoice'), 'CREATE_NEW', variables('newAvailabilitySetName'))]",
        "virtualNetworkName": "[parameters('vnetName')]",
        "vnetId": "[resourceId(parameters('vnetResourceGroupName'),'Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]",
        "publicIPAddressType": "Static",
        "mgmtPublicIPAddressName": "[concat(variables('dnsLabel'), '-mgmt-pip')]",
        "mgmtPublicIPAddressId": "[resourceId('Microsoft.Network/publicIPAddresses', variables('mgmtPublicIPAddressName'))]",
        "mgmtNsgID": "[resourceId('Microsoft.Network/networkSecurityGroups/',concat(variables('dnsLabel'),'-mgmt-nsg'))]",
        "mgmtNicName": "[concat(variables('dnsLabel'), '-mgmt')]",
        "mgmtSubnetName": "[parameters('mgmtSubnetName')]",
        "mgmtSubnetId": "[concat(variables('vnetId'), '/subnets/', variables('mgmtSubnetName'))]",
        "mgmtSubnetPrivateAddress": "[parameters('mgmtIpAddress')]",
        "intNsgID": "[resourceId('Microsoft.Network/networkSecurityGroups/',concat(variables('dnsLabel'),'-int-nsg'))]",
        "intNicName": "[concat(variables('dnsLabel'), '-int')]",
        "intSubnetName": "[parameters('internalSubnetName')]",
        "intSubnetId": "[concat(variables('vnetId'), '/subnets/', variables('intSubnetName'))]",
        "intSubnetPrivateAddress": "[parameters('internalIpAddressRangeStart')]",
        "intSubnetPrivateAddressPrefixArray": "[split(parameters('internalIpAddressRangeStart'), '.')]",
        "intSubnetPrivateAddressPrefix": "[concat(variables('intSubnetPrivateAddressPrefixArray')[0], '.', variables('intSubnetPrivateAddressPrefixArray')[1], '.', variables('intSubnetPrivateAddressPrefixArray')[2], '.')]",
        "intSubnetPrivateAddressSuffixInt": "[int(variables('intSubnetPrivateAddressPrefixArray')[3])]",
        "numberOfInternalIps": "[parameters('numberOfInternalIps')]",
        "tagValues": "[parameters('tagValues')]",
        "newDataStorageAccountName": "[concat(uniqueString(variables('dnsLabel'), resourceGroup().id, deployment().name), 'data000')]",
        "dataStorageAccountType": "Standard_LRS",
        "deploymentId": "[concat(variables('subscriptionId'), resourceGroup().id, deployment().name, variables('dnsLabel'))]",
        "customImage": "[replace(parameters('customImage'), 'OPTIONAL', '')]",
        "useCustomImage": "[not(empty(variables('customImage')))]",
        "createNewCustomImage": "[contains(variables('customImage'), 'https://')]",
        "newCustomImageName": "[concat(variables('dnsLabel'), 'image')]",
        "storageProfileArray": {
            "customImage": {
                "imageReference": {
                    "id": "[if(variables('createNewCustomImage'), resourceId('Microsoft.Compute/images', variables('newCustomImageName')), variables('customImage'))]"
                }
            },
            "platformImage": {
                "imageReference": "[variables('imageReference')]",
                "osDisk": {
                    "createOption": "FromImage"
                }
            }
        },
        "premiumInstanceArray": [
            "Standard_DS2",
            "Standard_DS3",
            "Standard_DS4",
            "Standard_DS11",
            "Standard_DS12",
            "Standard_DS13",
            "Standard_DS14",
            "Standard_DS2_v2",
            "Standard_DS3_v2",
            "Standard_DS4_v2",
            "Standard_DS5_v2",
            "Standard_DS11_v2",
            "Standard_DS12_v2",
            "Standard_DS13_v2",
            "Standard_DS14_v2",
            "Standard_DS15_v2",
            "Standard_F2S",
            "Standard_F4S",
            "Standard_F8S",
            "Standard_F16S",
            "Standard_GS2",
            "Standard_GS3",
            "Standard_GS4",
            "Standard_GS5"
        ],
        "bigiqConfigEncoded": "IyEgL3Vzci9sb2NhbC9iaW4vcHl0aG9uMi43CgppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IHRpbWUKaW1wb3J0IGFyZ3BhcnNlCmltcG9ydCBvcwoKIyB1c2FnZTogYmlnaXEtY29uZmlnLnB5IFstaF0KI1stLWxpY2Vuc2VrZXkgTElDRU5TRUtFWV0KI1stLW1hc3RlcmtleSBNQVNURVJLRVldCiNbLS1wZXJzb25hbGl0eSBQRVJTT05BTElUWV0gWy0taG9zdG5hbWUgSE9TVE5BTUVdCiNbLS1tYW5hZ2VtZW50SXBBZGRyZXNzIE1BTkFHRU1FTlRJUEFERFJFU1NdCiNbLS1tYW5hZ2VtZW50Um91dGVBZGRyZXNzIE1BTkFHRU1FTlRST1VURUFERFJFU1NdCiNbLS1kaXNjb3ZlcnlBZGRyZXNzIERJU0NPVkVSWUFERFJFU1NdCiNbLS10aW1lem9uZSBUSU1FWk9ORV0KI1stLW50cF9zZXJ2ZXJzIE5UUF9TRVJWRVJTIFtOVFBfU0VSVkVSUyAuLi5dXQojWy0tZG5zX3NlcnZlcnMgRE5TX1NFUlZFUlMgW0ROU19TRVJWRVJTIC4uLl1dCiNbLS11c2VyIFVTRVJdCiNbLS1wYXNzd29yZCBQQVNTV09SRF0KI1stLXV0aWxpdHkgVVRJTElUWSBMSUNFTlNFS0VZXQoKY2xhc3MgU2V0dXA6CgogICAgQkFTRV9VUkw9Imh0dHA6Ly9sb2NhbGhvc3Q6ODEwMCIKICAgIAogICAgZGVmIGdldF9hcmd1bWVudHMoc2VsZik6CiAgICAgICAgcGFyc2VyID0gYXJncGFyc2UuQXJndW1lbnRQYXJzZXIoZGVzY3JpcHRpb249J1NldHVwIGEgQklHLUlRIGluIG9uZSBjb21tYW5kJykKICAgICAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCItLWxpY2Vuc2VrZXkiLCB0eXBlPXN0ciwgaGVscD0iVGhlIGxpY2Vuc2Uga2V5IikKICAgICAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCItLW1hc3RlcmtleSIsIHR5cGU9c3RyLCBoZWxwPSJUaGUgbWFzdGVya2V5IHBhc3NwaHJhc2UiLCBkZWZhdWx0PSJUaGlzaXN0aGVtYXN0ZXJrZXkjMTIzNCIpCiAgICAgICAgcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1wZXJzb25hbGl0eSIsIHR5cGU9c3RyLCBoZWxwPSJUaGUgc3lzdGVtIHBlcnNvbmFsaXR5IHtiaWdfaXEsIGxvZ2dpbmdfbm9kZX0iLCBkZWZhdWx0PSJiaWdfaXEiKQogICAgICAgIHBhcnNlci5hZGRfYXJndW1lbnQoIi0taG9zdG5hbWUiLCB0eXBlPXN0ciwgaGVscD0iVGhlIHN5c3RlbSBob3N0bmFtZSIsIGRlZmF1bHQ9ImJpZ2lxMS5jb20iKQogICAgICAgIHBhcnNlci5hZGRfYXJndW1lbnQoIi0tbWFuYWdlbWVudElwQWRkcmVzcyIsIHR5cGU9c3RyLCBoZWxwPSJUaGUgbWFuYWdlbWVudCBJUCBhZGRyZXNzIGVnLiAxMC4xNDUuMS4xLzE2IiwgZGVmYXVsdD1Ob25lKQogICAgICAgICNwYXJzZXIuYWRkX2FyZ3VtZW50KCItLW1hbmFnZW1lbnRSb3V0ZUFkZHJlc3MiLCB0eXBlPXN0ciwgaGVscD0iVGhlIG1hbmFnZW1lbnQgcm91dGUgYWRkcmVzcyBlZy4gMTAuMTQ1LjEuMSIsIGRlZmF1bHQ9Tm9uZSkKICAgICAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCItLWRpc2NvdmVyeUFkZHJlc3MiLCB0eXBlPXN0ciwgaGVscD0iVGhlIGRpc2NvdmVyeSBhZGRyZXNzIGVnLiAxMC4xNDUuMS4xIiwgZGVmYXVsdD1Ob25lKQogICAgICAgIHBhcnNlci5hZGRfYXJndW1lbnQoIi0tdGltZXpvbmUiLCB0eXBlPXN0ciwgaGVscD0iVGhlIHN5c3RlbSB0aW1lem9uZSIsIGRlZmF1bHQ9IkFtZXJpY2EvTG9zX0FuZ2VsZXMiKQogICAgICAgIHBhcnNlci5hZGRfYXJndW1lbnQoIi0tdXNlciIsIHR5cGU9c3RyLCBoZWxwPSJUaGUgYWRtaW4gdXNlcm5hbWUiLCBkZWZhdWx0PSJhZG1pbiIpCiAgICAgICAgcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1wYXNzd29yZCIsIHR5cGU9c3RyLCBoZWxwPSJUaGUgYWRtaW4gcGFzc3dvcmQiLCBkZWZhdWx0PSJhZG1pbiIpCiAgICAgICAgcGFyc2VyLmFkZF9hcmd1bWVudCgKICAgICAgICAgICAgIi0tbnRwX3NlcnZlcnMiLAogICAgICAgICAgICB0eXBlPXN0ciwKICAgICAgICAgICAgbmFyZ3M9IisiLAogICAgICAgICAgICBoZWxwPSJOVFAgc2VydmVycyBhcyBhIGxpc3QsIGVnIC0tbnRwLXNlcnZlcnMgdGltZS5uaXN0LmdvdiB0aW1lLm1pY3Jvc29mdC5jb20iLAogICAgICAgICAgICBkZWZhdWx0PVsidGltZS5uaXN0LmdvdiJdCiAgICAgICAgKQogICAgICAgIHBhcnNlci5hZGRfYXJndW1lbnQoCiAgICAgICAgICAgICItLWRuc19zZXJ2ZXJzIiwKICAgICAgICAgICAgdHlwZT1zdHIsCiAgICAgICAgICAgIG5hcmdzPSIrIiwKICAgICAgICAgICAgaGVscD0iRE5TIHNlcnZlcnMgYXMgYSBsaXN0LCBlZyAtLWRucy1zZXJ2ZXJzIDguOC40LjQgOC44LjguOCA5LjkuOS45IiwKICAgICAgICAgICAgZGVmYXVsdD1bIjguOC44LjgiXQogICAgICAgICkKICAgICAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCItLXV0aWxpdHkiLCB0eXBlPXN0ciwgaGVscD0iVXRpbGl0eSBMaWNlbnNlIEtleSIpCiAgICAgICAgcmV0dXJuIHBhcnNlci5wYXJzZV9hcmdzKCkKCiAgICBkZWYgYXV0aChzZWxmLCB1c2VyLCBwYXNzd29yZCk6CiAgICAgICAgc2VsZi5zZXNzaW9uID0gcmVxdWVzdHMuc2Vzc2lvbigpCiAgICAgICAgc2VsZi5zZXNzaW9uLmF1dGggPSAoc3RyKHVzZXIpLCBzdHIocGFzc3dvcmQpKQoKICAgIGRlZiB3YWl0X2Zvcl9zZXR1cF9tb2RlKHNlbGYpOgogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHByaW50KCJXYWl0aW5nIGZvciBzZXR1cCBtb2RlIikKICAgICAgICAgICAgdGltZS5zbGVlcCg1KQogICAgICAgICAgICByZXN1bHQgPSBzZWxmLnNlc3Npb24uZ2V0KFNldHVwLkJBU0VfVVJMICsgIi9pbmZvL3N5c3RlbSIpCiAgICAgICAgICAgIGlmIHJlc3VsdC5zdGF0dXNfY29kZSAhPSAyMDA6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICByZXN1bHRfanNvbiA9IHJlc3VsdC5qc29uKCkKICAgICAgICAgICAgaWYgcmVzdWx0X2pzb24uZ2V0KCJhdmFpbGFibGUiKSBhbmQgcmVzdWx0X2pzb24uZ2V0KCJpc1NldHVwZCIpOgogICAgICAgICAgICAgICAgYnJlYWsKCiAgICBkZWYgc2V0X2xpY2Vuc2Uoc2VsZiwgbGljZW5zZV9rZXkpOgogICAgICAgIGlmIG5vdCBsaWNlbnNlX2tleToKICAgICAgICAgICAgcHJpbnQoIk5vIGxpY2Vuc2UgcHJvdmlkZWQsIHNraXBwaW5nIGxpY2Vuc2luZyIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBwcmludCgiU2V0dGluZyBsaWNlbnNlIHRvICIgKyBzdHIobGljZW5zZV9rZXkpKQoKICAgICAgICBpZiBsaWNlbnNlX2tleSA9PSAic2tpcExpY2Vuc2U6dHJ1ZSI6CiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuc2Vzc2lvbi5wb3N0KAogICAgICAgICAgICAgICAgU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvc2V0dXAvbGljZW5zZSIsCiAgICAgICAgICAgICAgICBqc29uPXsKICAgICAgICAgICAgICAgICAgICAibGljZW5zZVRleHQiOiAic2tpcExpY2Vuc2U6dHJ1ZSIKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIHJlc3VsdC5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICAgICAgcmVzdWx0X2JvZHkgPSByZXN1bHQuanNvbigpCiAgICAgICAgICAgIHByaW50KHJlc3VsdF9ib2R5KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuc2Vzc2lvbi5wb3N0KAogICAgICAgICAgICAgICAgU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvc2V0dXAvbGljZW5zZS9hY3RpdmF0ZSIsCiAgICAgICAgICAgICAgICBqc29uPXsKICAgICAgICAgICAgICAgICAgICAiYmFzZVJlZ0tleSI6IGxpY2Vuc2Vfa2V5LAogICAgICAgICAgICAgICAgICAgICJhZGRPbktleXMiOltdLAogICAgICAgICAgICAgICAgICAgICJhY3RpdmF0aW9uTWV0aG9kIjoiQVVUT01BVElDIgogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgcmVzdWx0LnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgICAgICByZXN1bHRfYm9keSA9IHJlc3VsdC5qc29uKCkKICAgICAgICAgICAgcHJpbnQocmVzdWx0X2JvZHkpCiAgICAgICAgICAgIGlmICJORUVEX0VVTEFfQUNDRVBUIiBpbiByZXN1bHRfYm9keS5nZXQoInN0YXR1cyIpOgogICAgICAgICAgICAgICAgcHJpbnQoIkFjY2VwdGluZyBFVUxBIikKCiAgICAgICAgICAgICAgICBhY2NlcHRfZXVsYV9ib2R5ID0gewogICAgICAgICAgICAgICAgICAgICJiYXNlUmVnS2V5IjogbGljZW5zZV9rZXksCiAgICAgICAgICAgICAgICAgICAgImRvc3NpZXIiOiByZXN1bHRfYm9keS5nZXQoImRvc3NpZXIiKSwKICAgICAgICAgICAgICAgICAgICAiZXVsYVRleHQiOiByZXN1bHRfYm9keS5nZXQoImV1bGFUZXh0IikKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuc2Vzc2lvbi5wb3N0KAogICAgICAgICAgICAgICAgICAgIFNldHVwLkJBU0VfVVJMICsgIi9tZ210L3NldHVwL2xpY2Vuc2UvYWNjZXB0LWV1bGEiLAogICAgICAgICAgICAgICAgICAgIGpzb249YWNjZXB0X2V1bGFfYm9keQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgcmVzdWx0LnJhaXNlX2Zvcl9zdGF0dXMoKQoKICAgICAgICBwcmludCgiU2F2aW5nIGxpY2Vuc2UgdG8gc2VydmljZS5jb25maWcuanNvbiIpCiAgICAgICAgc2VsZi5zZXNzaW9uLnBvc3QoCiAgICAgICAgICAgIFNldHVwLkJBU0VfVVJMICsgIi9tZ210L3NldHVwL2xpY2Vuc2UiLAogICAgICAgICAgICBqc29uPXsKICAgICAgICAgICAgICAgICJsaWNlbnNlVGV4dCI6IHJlc3VsdC5qc29uKCkuZ2V0KCJsaWNlbnNlVGV4dCIpCiAgICAgICAgICAgIH0pCgogICAgZGVmIHNldF9tYXN0ZXJrZXkoc2VsZiwgbWFzdGVya2V5KToKICAgICAgICBwcmludCgiU2V0dGluZyBtYXN0ZXIga2V5IHRvICIgKyBzdHIobWFzdGVya2V5KSkKICAgICAgICByZXN1bHQgPSBzZWxmLnNlc3Npb24ucG9zdCgKICAgICAgICAgICAgU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvc2V0dXAvbWFzdGVya2V5IiwKICAgICAgICAgICAganNvbj17CiAgICAgICAgICAgICAgICAicGFzc3BocmFzZSI6IG1hc3RlcmtleQogICAgICAgICAgICB9KQogICAgICAgIHJlc3VsdC5yYWlzZV9mb3Jfc3RhdHVzKCkKCiAgICBkZWYgc2V0X3BlcnNvbmFsaXR5KHNlbGYsIHBlcnNvbmFsaXR5KToKICAgICAgICBwcmludCgiU2V0dGluZyBwZXJzb25hbGl0eSB0byAiICsgc3RyKHBlcnNvbmFsaXR5KSkKICAgICAgICBzZWxmLnNlc3Npb24ucG9zdCgKICAgICAgICAgICAgU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvc2V0dXAvcGVyc29uYWxpdHkiLCBqc29uPXsgInN5c3RlbVBlcnNvbmFsaXR5IjogcGVyc29uYWxpdHkgfQogICAgICAgICkucmFpc2VfZm9yX3N0YXR1cygpCgogICAgZGVmIGFkZHJlc3Nlc19hcmVfdmFsaWQoc2VsZiwgYWRkcmVzc2VzKToKICAgICAgICByZXR1cm4gKAogICAgICAgICAgICBhZGRyZXNzZXMgaXMgbm90IE5vbmUgYW5kCiAgICAgICAgICAgIGFkZHJlc3Nlcy5nZXQoImhvc3RuYW1lIikgYW5kCiAgICAgICAgICAgIGFkZHJlc3Nlcy5nZXQoIm1hbmFnZW1lbnRJcEFkZHJlc3MiKSBhbmQKICAgICAgICAgICAgI2FkZHJlc3Nlcy5nZXQoIm1hbmFnZW1lbnRSb3V0ZUFkZHJlc3MiKSBhbmQKICAgICAgICAgICAgYWRkcmVzc2VzLmdldCgiZGlzY292ZXJ5QWRkcmVzcyIpCiAgICAgICAgKQoKICAgIGRlZiBzZXRfYWRkcmVzc2VzKHNlbGYsIGFkZHJlc3Nlcyk6CiAgICAgICAgaWYgbm90IHNlbGYuYWRkcmVzc2VzX2FyZV92YWxpZChhZGRyZXNzZXMpOgogICAgICAgICAgICBwcmludCgiTWlzc2luZyBhZGRyZXNzIGFyZ3VtZW50cywgc2tpcHBpbmcgZm9yIG5vdywgdGhpcyBpc24ndCBjcml0aWNhbCB0byBzZXR1cCIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBwcmludCgiU2V0dGluZyBhZGRyZXNzZXMgdG8iKQogICAgICAgIGJvZHkgPSB7CiAgICAgICAgICAgICAgICAiaG9zdG5hbWUiOmFkZHJlc3Nlcy5nZXQoImhvc3RuYW1lIiksCiAgICAgICAgICAgICAgICAibWFuYWdlbWVudElwQWRkcmVzcyI6YWRkcmVzc2VzLmdldCgibWFuYWdlbWVudElwQWRkcmVzcyIpLAogICAgICAgICAgICAgICAgIyJtYW5hZ2VtZW50Um91dGVBZGRyZXNzIjphZGRyZXNzZXMuZ2V0KCJtYW5hZ2VtZW50Um91dGVBZGRyZXNzIiksCiAgICAgICAgICAgICAgICAiZGlzY292ZXJ5QWRkcmVzcyI6YWRkcmVzc2VzLmdldCgiZGlzY292ZXJ5QWRkcmVzcyIpCiAgICAgICAgICAgIH0KICAgICAgICBwcmludChib2R5KQoKICAgICAgICBzZWxmLnNlc3Npb24ucG9zdCgKICAgICAgICAgICAgU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvc2V0dXAvYWRkcmVzcyIsCiAgICAgICAgICAgIGpzb249Ym9keSkucmFpc2VfZm9yX3N0YXR1cygpCgogICAgZGVmIHNldF9zZXJ2aWNlcyhzZWxmLCBudHBfc2VydmVycywgdGltZXpvbmUsIGRuc19zZXJ2ZXJzKToKICAgICAgICBwcmludCgiU2V0dGluZyBOVFAgc2VydmVycyIpCiAgICAgICAgc2VsZi5zZXNzaW9uLnBvc3QoU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvc2V0dXAvbnRwIiwganNvbj17ICJzZXJ2ZXJzIjogbnRwX3NlcnZlcnMsICJ0aW1lem9uZSI6IHRpbWV6b25lIH0pLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgIHByaW50KCJTZXR0aW5nIEROUyBzZXJ2ZXJzIikKICAgICAgICBzZWxmLnNlc3Npb24ucG9zdChTZXR1cC5CQVNFX1VSTCArICIvbWdtdC9zZXR1cC9kbnMiLCBqc29uPXsgInNlcnZlcnMiOiBkbnNfc2VydmVycywgInNlYXJjaCI6IFsgImxvY2FsaG9zdCIgXSB9KS5yYWlzZV9mb3Jfc3RhdHVzKCkKCgogICAgZGVmIGxhdW5jaF9iaWdpcShzZWxmKToKICAgICAgICBwcmludCgiTGF1bmNoaW5nIEJJRy1JUSIpCiAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLnBvc3QoU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvc2V0dXAvbGF1bmNoIikKICAgICAgICByZXN1bHQucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgc2tpcCA9IDAKICAgICAgICB0b3AgPSAxMDAKICAgICAgICB0aW1lc3RhbXAgPSByZXN1bHQuanNvbigpLmdldCgiZmlsZVRpbWVzdGFtcCIpCiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLmdldCgKICAgICAgICAgICAgICAgIFNldHVwLkJBU0VfVVJMICsgIi9tZ210L3NldHVwL2xhdW5jaC9tb25pdG9yP2RhdGV0aW1lPXtkYXRldGltZX0mdG9wPXt0b3B9JnNraXA9e3NraXB9IgogICAgICAgICAgICAgICAgICAgIC5mb3JtYXQoCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGV0aW1lPXRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICAgICAgdG9wPXRvcCwKICAgICAgICAgICAgICAgICAgICAgICAgc2tpcD1za2lwCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICApCgogICAgICAgICAgICByZXN1bHRfanNvbiA9IHJlc3VsdC5qc29uKCkKCiAgICAgICAgICAgIGlmIHJlc3VsdF9qc29uLmdldCgic3RhdHVzIikgPT0gIkNPTVBMRVRFIjoKICAgICAgICAgICAgICAgIHByaW50KCJTZXR1cCBjb21wbGV0ZSIpCiAgICAgICAgICAgICAgICBwcmludCgiR2V0IHBnaW5pdCBhbmQgdG9rdVVwZ3JhZGUgc3RhdHVzIHdpdGgiKQogICAgICAgICAgICAgICAgcHJpbnQoInRhaWwgLWYgL3Zhci9sb2cvYm9vdHN0cmFwLSIgKyB0aW1lc3RhbXAgKyAiLioiKQogICAgICAgICAgICAgICAgcHJpbnQoIkdldCByZXN0amF2YWQgc3RhdHVzIHdpdGgiKQogICAgICAgICAgICAgICAgcHJpbnQoInJlc3RjdXJsIC9zaGFyZWQvc3lzdGVtLXN0YXJ0ZWQiKQogICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIGpzb24gPSByZXN1bHQuanNvbigpCgogICAgICAgICAgICBsaW5lcyA9IHJlc3VsdC5qc29uKCkuZ2V0KCJsaW5lcyIpCiAgICAgICAgICAgIHNraXAgKz0gbGVuKGxpbmVzKQoKICAgICAgICAgICAgaWYgbGluZXM6CiAgICAgICAgICAgICAgICBwcmludCgiXG4iLmpvaW4obGluZXMpKQoKICAgICAgICAgICAgdGltZS5zbGVlcCgxKQoKICAgIGRlZiBlbmFibGVfYmFzaWNfYXV0aChzZWxmKToKICAgICAgICB3aXRoIG9wZW4oIi9ldGMvYmlnc3RhcnQvc2NyaXB0cy9zZXR1cGQiLCBtb2RlPSJyKyIpIGFzIHNldHVwZF9zY3JpcHQ6CiAgICAgICAgICAgIHByaW50KCJFbmFibGluZyBiYXNpYyBhdXRoIikKICAgICAgICAgICAgZmlsZV9jb250ZW50cyA9IHNldHVwZF9zY3JpcHQucmVhZCgpCiAgICAgICAgICAgIGZpbGVfY29udGVudHMgPSBmaWxlX2NvbnRlbnRzLnJlcGxhY2UoIiNleHBvcnQgQklHSVFfQkFTSUNfQVVUSF9FTkFCTEVEPVRydWUiLCAiZXhwb3J0IEJJR0lRX0JBU0lDX0FVVEhfRU5BQkxFRD1UcnVlIikKICAgICAgICAgICAgc2V0dXBkX3NjcmlwdC5zZWVrKDApCiAgICAgICAgICAgIHNldHVwZF9zY3JpcHQud3JpdGUoZmlsZV9jb250ZW50cykKICAgICAgICAgICAgc2V0dXBkX3NjcmlwdC50cnVuY2F0ZSgpCiAgICAgICAgcHJpbnQoIlJlc3RhcnRpbmcgc2V0dXBkIikKICAgICAgICBzdWJwcm9jZXNzLmNoZWNrX2NhbGwoWyJiaWdzdGFydCIsICJyZXN0YXJ0IiwgInNldHVwZCJdKQoKICAgIGRlZiB3YWl0X2Zvcl9pbml0aWFsX2FjdGl2YXRpb24oc2VsZik6CiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgcHJpbnQoIldhaXRpbmcgZm9yIGluaXRpYWxfYWN0aXZhdGlvbiBjbGllbnQiKQogICAgICAgICAgICB0aW1lLnNsZWVwKDUpCiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuc2Vzc2lvbi5nZXQoU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvY20vZGV2aWNlL2xpY2Vuc2luZy9wb29sL2luaXRpYWwtYWN0aXZhdGlvbiIpCiAgICAgICAgICAgIGlmIHJlc3VsdC5zdGF0dXNfY29kZSAhPSAyMDA6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICByZXN1bHRfanNvbiA9IHJlc3VsdC5qc29uKCkKICAgICAgICAgICAgaWYgcmVzdWx0X2pzb24uZ2V0KCJzZWxmTGluayIpID09ICJodHRwczovL2xvY2FsaG9zdC9tZ210L2NtL2RldmljZS9saWNlbnNpbmcvcG9vbC9pbml0aWFsLWFjdGl2YXRpb24iOgogICAgICAgICAgICAgICAgYnJlYWsKCiAgICBkZWYgY3JlYXRlX3V0aWxpdHlfcG9vbChzZWxmLCB1dGlsaXR5KToKICAgICAgICBpZiBub3QgdXRpbGl0eToKICAgICAgICAgICAgcHJpbnQoIk5vIGxpY2Vuc2UgcHJvdmlkZWQsIHNraXBwaW5nIGxpY2Vuc2UgcG9vbCBjcmVhdGlvbiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIHByaW50KCJBZGRpbmcgdXRpbGl0eSBsaWNlbnNlICIgKyBzdHIodXRpbGl0eSkpCiAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLnBvc3QoU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvY20vZGV2aWNlL2xpY2Vuc2luZy9wb29sL2luaXRpYWwtYWN0aXZhdGlvbiIsIGpzb249eyJyZWdLZXkiOiB1dGlsaXR5LCAibmFtZSI6ICJwcm9kdWN0aW9uIiwgInN0YXR1cyI6IkFDVElWQVRJTkdfQVVUT01BVElDIn0pCiAgICAgICAgcmVzdWx0LnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgIHJlc3VsdF9ib2R5ID0gcmVzdWx0Lmpzb24oKQogICAgICAgIHByaW50KHJlc3VsdF9ib2R5KQogICAgCiAgICBkZWYgYWN0aXZhdGVfdXRpbGl0eV9wb29sKHNlbGYsIHV0aWxpdHkpOgogICAgICAgIGlmIG5vdCB1dGlsaXR5OgogICAgICAgICAgICBwcmludCgiTm8gbGljZW5zZSBwcm92aWRlZCwgc2tpcHBpbmcgbGljZW5zZSBwb29sIGFjdGl2YXRpb24iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICByZXN1bHQgPSBzZWxmLnNlc3Npb24uZ2V0KAogICAgICAgICAgICBTZXR1cC5CQVNFX1VSTCArICIvbWdtdC9jbS9kZXZpY2UvbGljZW5zaW5nL3Bvb2wvaW5pdGlhbC1hY3RpdmF0aW9uLyIgKyBzdHIodXRpbGl0eSkKICAgICAgICAgICAgKQogICAgICAgIHJlc3VsdC5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICByZXN1bHRfYm9keSA9IHJlc3VsdC5qc29uKCkKICAgICAgICBldWxhX3RleHQgPSByZXN1bHRfYm9keS5nZXQoImV1bGFUZXh0IikgCiAgICAgICAgaWYgIk5FRURfRVVMQV9BQ0NFUFQiIGluIHJlc3VsdF9ib2R5LmdldCgic3RhdHVzIik6CiAgICAgICAgICAgIHByaW50KCJBY2NlcHRpbmcgRVVMQSIpCiAgICAgICAgICAgIGFjY2VwdF9ldWxhX2JvZHkgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogIkFDVElWQVRJTkdfQVVUT01BVElDX0VVTEFfQUNDRVBURUQiLAogICAgICAgICAgICAgICAgImV1bGFUZXh0IjogZXVsYV90ZXh0CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLnBhdGNoKAogICAgICAgICAgICAgICAgU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvY20vZGV2aWNlL2xpY2Vuc2luZy9wb29sL2luaXRpYWwtYWN0aXZhdGlvbi8iICsgc3RyKHV0aWxpdHkpLAogICAgICAgICAgICAgICAganNvbj1hY2NlcHRfZXVsYV9ib2R5CiAgICAgICAgICAgICkKICAgICAgICAgICAgcmVzdWx0LnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgICAgICByZXN1bHRfYm9keSA9IHJlc3VsdC5qc29uKCkKICAgICAgICAgICAgcHJpbnQocmVzdWx0X2JvZHkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoIkV1bGEgYWxyZWFkeSBhY2NlcHRlZCIpCiAgICAgICAgICAgIHByaW50KHJlc3VsdF9ib2R5KQoKICAgIGRlZiB2ZXJpZnlfdXRpbGl0eV9hY3RpdmF0aW9uKHNlbGYsIHV0aWxpdHkpOgogICAgICAgIGlmIG5vdCB1dGlsaXR5OgogICAgICAgICAgICBwcmludCgiTm8gbGljZW5zZSBwcm92aWRlZCwgc2tpcHBpbmcgbGljZW5zZSBwb29sIGFjdGl2YXRpb24gdmVyaWZpY2F0aW9uIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgcmVzdWx0ID0gc2VsZi5zZXNzaW9uLmdldCgKICAgICAgICAgICAgU2V0dXAuQkFTRV9VUkwgKyAiL21nbXQvY20vZGV2aWNlL2xpY2Vuc2luZy9wb29sL2luaXRpYWwtYWN0aXZhdGlvbi8iICsgc3RyKHV0aWxpdHkpCiAgICAgICAgICAgICkKICAgICAgICByZXN1bHQucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgcmVzdWx0X2JvZHkgPSByZXN1bHQuanNvbigpCiAgICAgICAgaSA9IDAKICAgICAgICB3aGlsZSAiUkVBRFkiIG5vdCBpbiByZXN1bHRfYm9keS5nZXQoInN0YXR1cyIpIGFuZCBpIDwgMTIwOgogICAgICAgICAgICBpKz0xCiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuc2Vzc2lvbi5nZXQoCiAgICAgICAgICAgICAgICBTZXR1cC5CQVNFX1VSTCArICIvbWdtdC9jbS9kZXZpY2UvbGljZW5zaW5nL3Bvb2wvaW5pdGlhbC1hY3RpdmF0aW9uLyIgKyBzdHIodXRpbGl0eSkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgcmVzdWx0LnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgICAgICByZXN1bHRfYm9keSA9IHJlc3VsdC5qc29uKCkKICAgICAgICAgICAgcHJpbnQoIkxpY2Vuc2Ugbm90IHJlYWR5OiIgKyBzdHIocmVzdWx0X2JvZHkpKQogICAgICAgICAgICBwcmludCgiV2FpdGluZyBmb3IgNSBzZWNvbmRzIikKICAgICAgICAgICAgdGltZS5zbGVlcCg1KQogICAgICAgIGlmIGkgPT0gMTIwOgogICAgICAgICAgICBwcmludCgiTUFYIHRyeSdzIHJlYWNoZWQsIGV4aXRpbmciKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50KCJMaWNlbnNlIHJlYWR5OiIgKyBzdHIocmVzdWx0X2JvZHkpKQogICAgICAgICAgICBzZWxmLnRvdWNoKCIvY29uZmlnL2Nsb3VkL2NvbmZpZ19jb21wbGV0ZSIpCgogICAgZGVmIHRvdWNoKHNlbGYsIHBhdGgpOgogICAgICAgIHdpdGggb3BlbihwYXRoLCAnYScpOgogICAgICAgICAgICBvcy51dGltZShwYXRoLCBOb25lKQoKICAgIGRlZiBtYWluKHNlbGYpOgogICAgICAgIGFyZ3MgPSBzZWxmLmdldF9hcmd1bWVudHMoKQogICAgICAgIHRpbWUuc2xlZXAoMTgwKQogICAgICAgIHByaW50KCJSdW5uaW5nIEJJR0lRIGNvbmZpZ3VyYXRpb24gd2l0aCB0aGVzZSBhcmd1bWVudHMiKQogICAgICAgIHByaW50KGFyZ3MpCiAgICAgICAgc2VsZi5lbmFibGVfYmFzaWNfYXV0aCgpCiAgICAgICAgdGltZS5zbGVlcCg1KQogICAgICAgIHNlbGYuYXV0aChhcmdzLnVzZXIsYXJncy5wYXNzd29yZCkKICAgICAgICB0aW1lLnNsZWVwKDUpCiAgICAgICAgc2VsZi53YWl0X2Zvcl9zZXR1cF9tb2RlKCkKICAgICAgICBzZWxmLnNldF9saWNlbnNlKGFyZ3MubGljZW5zZWtleSkKICAgICAgICBzZWxmLnNldF9tYXN0ZXJrZXkoYXJncy5tYXN0ZXJrZXkpCiAgICAgICAgc2VsZi5zZXRfcGVyc29uYWxpdHkoYXJncy5wZXJzb25hbGl0eSkKICAgICAgICBzZWxmLnNldF9hZGRyZXNzZXMoewogICAgICAgICAgICAgICAgImhvc3RuYW1lIjogYXJncy5ob3N0bmFtZSwKICAgICAgICAgICAgICAgICJtYW5hZ2VtZW50SXBBZGRyZXNzIjogYXJncy5tYW5hZ2VtZW50SXBBZGRyZXNzLAogICAgICAgICAgICAgICAgIyJtYW5hZ2VtZW50Um91dGVBZGRyZXNzIjogYXJncy5tYW5hZ2VtZW50Um91dGVBZGRyZXNzLAogICAgICAgICAgICAgICAgImRpc2NvdmVyeUFkZHJlc3MiOiBhcmdzLmRpc2NvdmVyeUFkZHJlc3MKICAgICAgICAgICAgfSkKICAgICAgICBzZWxmLnNldF9zZXJ2aWNlcyhudHBfc2VydmVycz1hcmdzLm50cF9zZXJ2ZXJzLCB0aW1lem9uZT1hcmdzLnRpbWV6b25lLCBkbnNfc2VydmVycz1hcmdzLmRuc19zZXJ2ZXJzKQogICAgICAgIHNlbGYubGF1bmNoX2JpZ2lxKCkKICAgICAgICB0aW1lLnNsZWVwKDEyMCkKICAgICAgICBzZWxmLmVuYWJsZV9iYXNpY19hdXRoKCkKICAgICAgICBzZWxmLmF1dGgoYXJncy51c2VyLGFyZ3MucGFzc3dvcmQpCiAgICAgICAgdGltZS5zbGVlcCgxNSkKICAgICAgICBzZWxmLndhaXRfZm9yX2luaXRpYWxfYWN0aXZhdGlvbigpCiAgICAgICAgdGltZS5zbGVlcCgxNSkKICAgICAgICBzZWxmLmNyZWF0ZV91dGlsaXR5X3Bvb2woYXJncy51dGlsaXR5KQogICAgICAgIHRpbWUuc2xlZXAoMTUpCiAgICAgICAgc2VsZi5hY3RpdmF0ZV91dGlsaXR5X3Bvb2woYXJncy51dGlsaXR5KQogICAgICAgIHNlbGYudmVyaWZ5X3V0aWxpdHlfYWN0aXZhdGlvbihhcmdzLnV0aWxpdHkpCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgc2V0dXAgPSBTZXR1cCgpCiAgICBzZXR1cC5tYWluKCk=",
        "customConfig": "### START (INPUT) CUSTOM CONFIGURATION HERE\n",
        "installCustomConfig": "[concat(variables('singleQuote'), '#!/bin/bash\n', variables('customConfig'), variables('singleQuote'))]"
    },
    "resources": [
        {
            "apiVersion": "[variables('networkApiVersion')]",
            "location": "[variables('location')]",
            "name": "[variables('mgmtPublicIPAddressName')]",
            "properties": {
                "dnsSettings": {
                    "domainNameLabel": "[variables('dnsLabel')]"
                },
                "idleTimeoutInMinutes": 30,
                "publicIPAllocationMethod": "[variables('publicIPAddressType')]"
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Network/publicIPAddresses"
        },
        {
            "apiVersion": "[variables('networkApiVersion')]",
            "dependsOn": [
                "[variables('mgmtPublicIPAddressId')]",
                "[variables('mgmtNsgID')]"
            ],
            "location": "[variables('location')]",
            "name": "[variables('mgmtNicName')]",
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "[concat(variables('instanceName'), '-ipconfig1')]",
                        "properties": {
                            "PublicIpAddress": {
                                "Id": "[variables('mgmtPublicIPAddressId')]"
                            },
                            "privateIPAddress": "[variables('mgmtSubnetPrivateAddress')]",
                            "privateIPAllocationMethod": "Static",
                            "subnet": {
                                "id": "[variables('mgmtSubnetId')]"
                            }
                        }
                    }
                ],
                "networkSecurityGroup": {
                    "id": "[variables('mgmtNsgID')]"
                }
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Network/networkInterfaces"
        },
        {
            "apiVersion": "[variables('networkApiVersion')]",
            "dependsOn": [
                "[variables('intNsgID')]"
            ],
            "location": "[variables('location')]",
            "name": "[variables('intNicName')]",
            "properties": {
                "copy": [
                    {
                        "count": "[add(variables('numberOfInternalIps'), 1)]",
                        "input": {
                            "name": "[if(equals(copyIndex('ipConfigurations', 1), 1), concat(variables('instanceName'), '-self-ipconfig'), concat(variables('resourceGroupName'), '-int-ipconfig', sub(copyIndex('ipConfigurations', 1), 2)))]",
                            "properties": {
                                "primary": "[if(equals(copyIndex('ipConfigurations', 1), 1), 'True', 'False')]",
                                "privateIPAddress": "[if(equals(copyIndex('ipConfigurations', 1), 1), variables('intSubnetPrivateAddress'), concat(variables('intSubnetPrivateAddressPrefix'), add(variables('intSubnetPrivateAddressSuffixInt'), sub(copyIndex('ipConfigurations', 1), 1))))]",
                                "privateIPAllocationMethod": "Static",
                                "subnet": {
                                    "id": "[variables('intSubnetId')]"
                                }
                            }
                        },
                        "name": "ipConfigurations"
                    }
                ],
                "networkSecurityGroup": {
                    "id": "[concat(variables('intNsgID'))]"
                }
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Network/networkInterfaces"
        },
        {
            "apiVersion": "[variables('networkApiVersion')]",
            "location": "[variables('location')]",
            "name": "[concat(variables('dnsLabel'), '-mgmt-nsg')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "mgmt_allow_https",
                        "properties": {
                            "access": "Allow",
                            "description": "",
                            "destinationAddressPrefix": "*",
                            "destinationPortRange": "443",
                            "direction": "Inbound",
                            "priority": 101,
                            "protocol": "Tcp",
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddress')]",
                            "sourcePortRange": "*"
                        }
                    },
                    {
                        "name": "allow_ssh_22",
                        "properties": {
                            "access": "Allow",
                            "description": "",
                            "destinationAddressPrefix": "*",
                            "destinationPortRange": "22",
                            "direction": "Inbound",
                            "priority": 102,
                            "protocol": "Tcp",
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddress')]",
                            "sourcePortRange": "*"
                        }
                    }
                ]
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Network/networkSecurityGroups"
        },
        {
            "apiVersion": "[variables('networkApiVersion')]",
            "location": "[variables('location')]",
            "name": "[concat(variables('dnsLabel'), '-int-nsg')]",
            "properties": {
                "securityRules": [
                    {
                        "name": "int_allow_https",
                        "properties": {
                            "access": "Allow",
                            "description": "",
                            "destinationAddressPrefix": "*",
                            "destinationPortRange": "443",
                            "direction": "Inbound",
                            "priority": 101,
                            "protocol": "Tcp",
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddressApp')]",
                            "sourcePortRange": "*"
                        }
                    },
                    {
                        "name": "int_allow_ssh_22",
                        "properties": {
                            "access": "Allow",
                            "description": "",
                            "destinationAddressPrefix": "*",
                            "destinationPortRange": "22",
                            "direction": "Inbound",
                            "priority": 102,
                            "protocol": "Tcp",
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddressApp')]",
                            "sourcePortRange": "*"
                        }
                    }
                ]
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Network/networkSecurityGroups"
        },
        {
            "apiVersion": "[variables('computeApiVersion')]",
            "condition": "[equals(toUpper(parameters('avSetChoice')), 'CREATE_NEW')]",
            "location": "[variables('location')]",
            "name": "[variables('availabilitySetName')]",
            "properties": {
                "PlatformFaultDomainCount": 2,
                "PlatformUpdateDomainCount": 2
            },
            "sku": {
                "name": "Aligned"
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Compute/availabilitySets"
        },
        {
            "apiVersion": "[variables('storageApiVersion')]",
            "kind": "Storage",
            "location": "[variables('location')]",
            "name": "[variables('newDataStorageAccountName')]",
            "properties": {
                "supportsHttpsTrafficOnly": true
            },
            "sku": {
                "name": "[variables('dataStorageAccountType')]",
                "tier": "Standard"
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Storage/storageAccounts"
        },
        {
            "apiVersion": "[variables('computeApiVersion')]",
            "condition": "[and(variables('useCustomImage'), variables('createNewCustomImage'))]",
            "location": "[variables('location')]",
            "name": "[variables('newCustomImageName')]",
            "properties": {
                "storageProfile": {
                    "osDisk": {
                        "blobUri": "[variables('customImage')]",
                        "osState": "Generalized",
                        "osType": "Linux",
                        "storageAccountType": "[if(contains(variables('premiumInstanceArray'), parameters('instanceType')), 'Premium_LRS', 'Standard_LRS')]"
                    }
                }
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Compute/images"
        },
        {
            "apiVersion": "[variables('computeApiVersion')]",
            "dependsOn": [
                "[concat('Microsoft.Storage/storageAccounts/', variables('newDataStorageAccountName'))]",
                "[concat('Microsoft.Compute/availabilitySets/', variables('availabilitySetName'))]",
                "[variables('newCustomImageName')]",
                "[concat('Microsoft.Network/networkInterfaces/', variables('mgmtNicName'))]",
                "[concat('Microsoft.Network/networkInterfaces/', variables('intNicName'))]"
            ],
            "location": "[variables('location')]",
            "name": "[variables('instanceName')]",
            "plan": "[if(variables('useCustomImage'), json('null'), variables('imagePlan'))]",
            "properties": {
                "availabilitySet": {
                    "id": "[resourceId('Microsoft.Compute/availabilitySets',variables('availabilitySetName'))]"
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "[reference(concat('Microsoft.Storage/storageAccounts/', variables('newDataStorageAccountName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).primaryEndpoints.blob]"
                    }
                },
                "hardwareProfile": {
                    "vmSize": "[parameters('instanceType')]"
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('mgmtNicName'))]",
                            "properties": {
                                "primary": true
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('intNicName'))]",
                            "properties": {
                                "primary": false
                            }
                        }
                    ]
                },
                "osProfile": {
                    "adminPassword": "[variables('adminPassword')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "computerName": "[variables('instanceName')]",
                    "linuxConfiguration": "[json('null')]"
                },
                "storageProfile": "[if(variables('useCustomImage'), variables('storageProfileArray').customImage, variables('storageProfileArray').platformImage)]"
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Compute/virtualMachines"
        },
        {
            "apiVersion": "[variables('computeApiVersion')]",
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', variables('instanceName'))]"
            ],
            "location": "[variables('location')]",
            "name": "[concat(variables('instanceName'),'/start')]",
            "properties": {
                "protectedSettings": {
                    "commandToExecute": "[concat('mkdir -p /var/log/cloud/azure; mkdir -p /config/cloud; set-basic-auth on; echo ', variables('bigiqConfigEncoded'), ' | /usr/bin/base64 -d > /config/cloud/bigiqConfigEncoded.sh; chmod +x /config/cloud/bigiqConfigEncoded.sh;', ' /config/cloud/bigiqConfigEncoded.sh --licensekey ', parameters('bigIqLicenseKey1'), ' --ntp_servers ', parameters('ntpServer'), ' --timezone ', parameters('timeZone'), ' --utility ', parameters('licensePoolKeys'), ' --password ', variables('adminPassword'), ' --masterkey ', parameters('masterKey'), ' &>> /var/log/cloud/azure/install.log &')]"
                },
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.0"
            },
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]",
            "type": "Microsoft.Compute/virtualMachines/extensions"
        }
    ],
    "outputs": {
        "GUI-URL": {
            "type": "string",
            "value": "[concat('https://', reference(variables('mgmtPublicIPAddressId')).dnsSettings.fqdn, ':', 443)]"
        },
        "SSH-URL": {
            "type": "string",
            "value": "[concat(reference(variables('mgmtPublicIPAddressId')).dnsSettings.fqdn, ' ',22)]"
        },
        "bigiqIp": {
            "type": "string",
            "value": "[reference(variables('mgmtPublicIPAddressName')).ipAddress]"
        }
    }
}